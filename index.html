<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Si-3.26 –ê–Ω–∞–ª–∏—Ç–∏–∫ | –°–∏–≥–Ω–∞–ª—ã + –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</title>
    <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg: #0d1117;
            --card: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --accent: #8957e5;
            --buy: #238636;
            --sell: #f85149;
            --news-high: #f85149;
            --news-medium: #f0883e;
            --news-low: #58a6ff;
            --calendar-high: #f85149;
            --calendar-medium: #f0883e;
            --calendar-low: #58a6ff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 12px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h2 {
            text-align: center;
            font-size: clamp(1.2rem, 5vw, 1.8rem);
            margin: 0 0 12px 0;
            font-weight: 500;
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            position: relative;
        }

        #chart {
            height: 400px;
            width: 100%;
            position: relative;
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
        }

        .timeframe-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            justify-content: flex-start;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        .tf-btn {
            background: transparent;
            color: var(--text);
            border: 1px solid transparent;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.7;
            white-space: nowrap;
            min-width: 50px;
            text-align: center;
        }

        .tf-btn.active {
            background: var(--accent);
            color: white;
            opacity: 1;
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(137, 87, 229, 0.4);
        }

        .tf-btn:hover {
            opacity: 1;
            background: rgba(137, 87, 229, 0.2);
            border-color: var(--accent);
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .notification {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease, pulse 2s infinite;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .notification:hover {
            transform: translateX(-5px);
        }

        .notification.buy {
            border-color: var(--buy);
            background: rgba(35, 134, 54, 0.15);
        }

        .notification.sell {
            border-color: var(--sell);
            background: rgba(248, 81, 73, 0.15);
        }

        .notification-icon {
            font-size: 32px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-text {
            font-size: 12px;
            color: #8b949e;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
        }

        .notification-close:hover {
            opacity: 1;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
            50% { box-shadow: 0 8px 32px rgba(137, 87, 229, 0.3); }
        }

        /* –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å */
        .calendar-container {
            margin-top: 16px;
            max-height: 350px;
            overflow-y: auto;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .calendar-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calendar-badge {
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .calendar-item {
            background: #0d1117;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .calendar-item:hover {
            border-color: var(--accent);
        }

        .calendar-item.high { border-left-color: var(--calendar-high); }
        .calendar-item.medium { border-left-color: var(--calendar-medium); }
        .calendar-item.low { border-left-color: var(--calendar-low); }

        .calendar-time {
            font-size: 12px;
            color: #8b949e;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calendar-country {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #21262d;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .calendar-event {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .calendar-values {
            display: flex;
            gap: 12px;
            font-size: 12px;
            margin-top: 8px;
        }

        .calendar-value {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .calendar-value-label {
            color: #8b949e;
            font-size: 10px;
            text-transform: uppercase;
        }

        .calendar-value-num {
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .calendar-impact {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 6px;
        }

        .impact-high { background: rgba(248, 81, 73, 0.2); color: var(--calendar-high); }
        .impact-medium { background: rgba(240, 136, 62, 0.2); color: var(--calendar-medium); }
        .impact-low { background: rgba(88, 166, 255, 0.2); color: var(--calendar-low); }

        .calendar-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .filter-btn:hover {
            border-color: var(--accent);
        }

        /* –ù–æ–≤–æ—Å—Ç–∏ */
        .news-container {
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .news-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .news-badge {
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .news-item {
            background: #0d1117;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .news-item:hover {
            border-color: var(--accent);
        }

        .news-item.high { border-left-color: var(--news-high); }
        .news-item.medium { border-left-color: var(--news-medium); }
        .news-item.low { border-left-color: var(--news-low); }

        .news-time {
            font-size: 11px;
            color: #8b949e;
            margin-bottom: 4px;
        }

        .news-text {
            font-size: 13px;
            line-height: 1.5;
        }

        .news-sentiment {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 6px;
        }

        .sentiment-bullish { background: rgba(35, 134, 54, 0.2); color: #3fb950; }
        .sentiment-bearish { background: rgba(248, 81, 73, 0.2); color: var(--sell); }
        .sentiment-neutral { background: rgba(139, 148, 158, 0.2); color: #8b949e; }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–ª–∏—è–Ω–∏—è */
        .influence-panel {
            background: #0d1117;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .influence-title {
            font-size: 12px;
            color: #8b949e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .influence-bars {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .influence-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .influence-label {
            font-size: 11px;
            min-width: 80px;
            color: #8b949e;
        }

        .influence-bar {
            flex: 1;
            height: 8px;
            background: #21262d;
            border-radius: 4px;
            overflow: hidden;
        }

        .influence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .influence-fill.bullish { background: linear-gradient(90deg, #238636, #3fb950); }
        .influence-fill.bearish { background: linear-gradient(90deg, #f85149, #ff7b72); }
        .influence-fill.neutral { background: linear-gradient(90deg, #484f58, #8b949e); }

        .influence-value {
            font-size: 11px;
            font-weight: 600;
            min-width: 40px;
            text-align: right;
        }

        /* –ò—Å—Ç–æ—Ä–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤ */
        .signal-history {
            margin-top: 16px;
            max-height: 200px;
            overflow-y: auto;
        }

        .signal-history-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .signal-history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #0d1117;
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 12px;
            border-left: 3px solid transparent;
        }

        .signal-history-item.buy { border-left-color: var(--buy); }
        .signal-history-item.sell { border-left-color: var(--sell); }
        .signal-history-item.hold { border-left-color: #8b949e; }

        .signal-history-time {
            color: #8b949e;
            min-width: 60px;
        }

        .signal-history-signal {
            font-weight: 600;
            min-width: 80px;
        }

        .signal-history-price {
            color: #8b949e;
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #21262d;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--accent);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        .signal-display {
            text-align: center;
            padding: 16px;
            border-radius: 16px;
            border: 2px solid var(--border);
            margin-bottom: 16px;
            transition: all 0.3s;
        }

        .signal-display.buy {
            border-color: var(--buy);
            color: #3fb950;
            background: rgba(35, 134, 54, 0.15);
        }

        .signal-display.sell {
            border-color: var(--sell);
            color: var(--sell);
            background: rgba(248, 81, 73, 0.15);
        }

        .signal-display.hold {
            border-color: #8b949e;
            color: #8b949e;
        }

        .auto-update-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 16px 0;
            padding: 8px 0;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .auto-update-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .timer {
            background: #21262d;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            font-family: monospace;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            background: #0d1117;
            color: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-top: 8px;
            font-size: 16px;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 14px 16px;
            cursor: pointer;
            border-radius: 14px;
            width: 100%;
            font-weight: 600;
            font-size: 16px;
            margin-top: 10px;
            transition: all 0.2s;
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        button:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        button.small {
            background: #21262d;
            padding: 10px;
            font-size: 14px;
            margin-top: 8px;
        }

        button.small.active {
            background: var(--accent);
        }

        .info {
            font-size: 13px;
            color: #8b949e;
            margin: 10px 0 0;
            word-break: break-word;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card);
            padding: 12px 24px;
            border-radius: 40px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px black;
            white-space: nowrap;
            font-size: 14px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .last-update {
            text-align: center;
            font-size: 12px;
            color: #8b949e;
            margin-top: 8px;
        }

        .price-ticker {
            display: flex;
            justify-content: space-around;
            margin: 12px 0;
            padding: 12px;
            background: #0d1117;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .ticker-item {
            text-align: center;
        }

        .ticker-label {
            font-size: 11px;
            color: #8b949e;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .ticker-value {
            font-size: 20px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .ticker-change {
            font-size: 12px;
            margin-top: 2px;
        }

        .positive { color: #3fb950; }
        .negative { color: #f85149; }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .stat-item {
            background: #0d1117;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            border: 1px solid var(--border);
        }

        .stat-label {
            color: #8b949e;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .stat-value {
            color: var(--text);
            font-weight: 600;
            font-size: 13px;
        }

        .analysis-summary {
            background: #0d1117;
            border-radius: 12px;
            padding: 12px;
            margin-top: 12px;
            border: 1px solid var(--border);
        }

        .analysis-title {
            font-size: 12px;
            color: var(--accent);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .analysis-factors {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .factor-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .factor-icon {
            font-size: 14px;
        }

        .factor-text {
            flex: 1;
            color: #8b949e;
        }

        .factor-score {
            font-weight: 600;
            min-width: 30px;
            text-align: right;
        }

        .factor-score.positive { color: #3fb950; }
        .factor-score.negative { color: #f85149; }
        .factor-score.neutral { color: #8b949e; }

        @media (max-width: 1100px) {
            .grid { grid-template-columns: 1fr; }
            #chart { height: 350px; }
            .notification-container {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }

        @media (max-width: 600px) {
            body { padding: 8px; }
            .card { padding: 12px; }
            .tf-btn { padding: 6px 10px; font-size: 12px; }
            #chart { height: 280px; }
        }
    </style>
</head>
<body>
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div class="notification-container" id="notificationContainer"></div>

    <h2>–ê–Ω–∞–ª–∏–∑ Si-3.26 (H6) | –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–∏–≥–Ω–∞–ª–æ–≤</h2>

    <div class="grid">
        <div class="card" id="chartContainer">
            <div class="timeframe-selector" id="tfSelector">
                <button class="tf-btn" data-tf="1" type="button">M1</button>
                <button class="tf-btn" data-tf="10" type="button">M10</button>
                <button class="tf-btn active" data-tf="60" type="button">1H</button>
                <button class="tf-btn" data-tf="240" type="button">4H</button>
                <button class="tf-btn" data-tf="1440" type="button">1D</button>
                <button class="tf-btn" data-tf="10080" type="button">1W</button>
            </div>
            <div id="chart">
                <div id="loading"><div class="spinner"></div> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö MOEX...</div>
            </div>
            <div class="last-update" id="lastUpdate">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: -</div>

            <!-- –ü–∞–Ω–µ–ª—å –≤–ª–∏—è–Ω–∏—è —Ñ–∞–∫—Ç–æ—Ä–æ–≤ -->
            <div class="influence-panel" id="influencePanel">
                <div class="influence-title">
                    <span>üìä –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ñ–∞–∫—Ç–æ—Ä–æ–≤</span>
                </div>
                <div class="influence-bars">
                    <div class="influence-row">
                        <span class="influence-label">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π</span>
                        <div class="influence-bar">
                            <div class="influence-fill neutral" id="techBar" style="width: 50%"></div>
                        </div>
                        <span class="influence-value" id="techScore">0</span>
                    </div>
                    <div class="influence-row">
                        <span class="influence-label">–ù–æ–≤–æ—Å—Ç–∏</span>
                        <div class="influence-bar">
                            <div class="influence-fill neutral" id="newsBar" style="width: 50%"></div>
                        </div>
                        <span class="influence-value" id="newsScore">0</span>
                    </div>
                    <div class="influence-row">
                        <span class="influence-label">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
                        <div class="influence-bar">
                            <div class="influence-fill neutral" id="calendarBar" style="width: 50%"></div>
                        </div>
                        <span class="influence-value" id="calendarScore">0</span>
                    </div>
                    <div class="influence-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
                        <span class="influence-label" style="font-weight: 600; color: var(--text);">–ò–¢–û–ì–û</span>
                        <div class="influence-bar">
                            <div class="influence-fill neutral" id="totalBar" style="width: 50%"></div>
                        </div>
                        <span class="influence-value" id="totalScore" style="font-weight: 700;">0</span>
                    </div>
                </div>
            </div>

            <!-- –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å -->
            <div class="calendar-container" id="calendarContainer">
                <div class="calendar-header">
                    <div class="calendar-title">
                        <span>üìÖ –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</span>
                        <span class="calendar-badge" id="calendarCount">0</span>
                    </div>
                    <button class="small" onclick="refreshCalendar()" style="width: auto; padding: 6px 12px; margin: 0;">üîÑ</button>
                </div>
                <div class="calendar-filter">
                    <button class="filter-btn active" onclick="filterCalendar('all')">–í—Å–µ</button>
                    <button class="filter-btn" onclick="filterCalendar('high')">üî¥ –í–∞–∂–Ω—ã–µ</button>
                    <button class="filter-btn" onclick="filterCalendar('medium')">üü° –°—Ä–µ–¥–Ω–∏–µ</button>
                    <button class="filter-btn" onclick="filterCalendar('usd')">üíµ USD</button>
                    <button class="filter-btn" onclick="filterCalendar('rub')">üá∑üá∫ RUB</button>
                </div>
                <div id="calendarList">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...</div>
            </div>

            <!-- –ù–æ–≤–æ—Å—Ç–Ω–æ–π —Ñ–æ–Ω -->
            <div class="news-container" id="newsContainer">
                <div class="news-header">
                    <div class="news-title">
                        <span>üì∞ –ù–æ–≤–æ—Å—Ç–Ω–æ–π —Ñ–æ–Ω</span>
                        <span class="news-badge" id="newsCount">0</span>
                    </div>
                    <button class="small" onclick="refreshNews()" style="width: auto; padding: 6px 12px; margin: 0;">üîÑ</button>
                </div>
                <div class="calendar-filter">
                    <button class="filter-btn active" onclick="filterNews('all')">–í—Å–µ</button>
                    <button class="filter-btn" onclick="filterNews('bullish')">üìà –ë—ã—á—å–∏</button>
                    <button class="filter-btn" onclick="filterNews('bearish')">üìâ –ú–µ–¥–≤–µ–∂—å–∏</button>
                </div>
                <div id="newsList">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</div>
            </div>
        </div>

        <div class="side">
            <div class="card">
                <div class="price-ticker" id="priceTicker">
                    <div class="ticker-item">
                        <div class="ticker-label">–¶–µ–Ω–∞</div>
                        <div class="ticker-value" id="currentPrice">-</div>
                        <div class="ticker-change" id="priceChange">-</div>
                    </div>
                    <div class="ticker-item">
                        <div class="ticker-label">–ò–∑–º–µ–Ω–µ–Ω–∏–µ</div>
                        <div class="ticker-value" id="changePercent">-</div>
                        <div class="ticker-change" id="changeValue">-</div>
                    </div>
                </div>

                <div id="signal_ui" class="signal-display hold">
                    <div style="font-size: 11px; opacity: 0.7;">–¢–ï–ö–£–©–ò–ô –°–ò–ì–ù–ê–õ</div>
                    <div id="signal_text" style="font-size: 26px; font-weight: bold;">–û–ñ–ò–î–ê–ù–ò–ï</div>
                    <div id="signal_confidence" style="font-size: 12px; margin-top: 4px; opacity: 0.8;"></div>
                </div>

                <div id="ai_desc" class="info">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</div>

                <!-- –°–≤–æ–¥–∫–∞ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ -->
                <div class="analysis-summary" id="analysisSummary" style="display: none;">
                    <div class="analysis-title">üìã –§–∞–∫—Ç–æ—Ä—ã —Ä–µ—à–µ–Ω–∏—è</div>
                    <div class="analysis-factors" id="analysisFactors"></div>
                </div>

                <div class="stats-grid" id="statsGrid" style="display: none;">
                    <div class="stat-item"><div class="stat-label">RSI (14)</div><div class="stat-value" id="statRsi">-</div></div>
                    <div class="stat-item"><div class="stat-label">MACD</div><div class="stat-value" id="statMacd">-</div></div>
                    <div class="stat-item"><div class="stat-label">EMA 20/50</div><div class="stat-value" id="statEma">-</div></div>
                    <div class="stat-item"><div class="stat-label">–¢—Ä–µ–Ω–¥</div><div class="stat-value" id="statTrend">-</div></div>
                </div>

                <div class="auto-update-row">
                    <label class="auto-update-label">
                        <input type="checkbox" id="autoUpdateCheck" checked> –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (30 —Å–µ–∫)
                    </label>
                    <span class="timer" id="timerDisplay">00:30</span>
                </div>

                <button onclick="runComplexAnalysis()" type="button"> –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –ê–ù–ê–õ–ò–ó</button>
                <button class="small" onclick="toggleProxy()" id="proxyBtn" type="button">üîÅ CORS-–ø—Ä–æ–∫—Å–∏: –í–´–ö–õ</button>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
            <div class="card" style="margin-top: 16px;">
                <div style="font-weight: 600; margin-bottom: 12px; color: var(--accent);">üîî –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤</div>

                <div class="settings-row">
                    <span class="settings-label">üîä –ó–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª</span>
                    <div class="toggle-switch active" id="soundToggle" onclick="toggleSetting('sound')"></div>
                </div>

                <div class="settings-row">
                    <span class="settings-label">üí¨ –í–∏–∑—É–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                    <div class="toggle-switch active" id="notificationToggle" onclick="toggleSetting('notification')"></div>
                </div>

                <div class="settings-row" style="border-bottom: none;">
                    <span class="settings-label">üì± –¢–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ (BUY/SELL)</span>
                    <div class="toggle-switch active" id="importantOnlyToggle" onclick="toggleSetting('importantOnly')"></div>
                </div>

                <button class="small" onclick="testSignal()" style="margin-top: 12px;">üß™ –¢–µ—Å—Ç —Å–∏–≥–Ω–∞–ª–∞</button>
            </div>

            <!-- –ò—Å—Ç–æ—Ä–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤ -->
            <div class="card" style="margin-top: 16px;">
                <div class="signal-history-title">üìú –ò—Å—Ç–æ—Ä–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤</div>
                <div class="signal-history" id="signalHistory">
                    <div style="text-align: center; color: #8b949e; font-size: 12px; padding: 20px;">
                        –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 16px;">
                <label style="font-weight: 500;">üîë OpenRouter API Key:</label>
                <input type="password" id="api_key_input" placeholder="sk-or-v1-..." value="">
                <button style="background: #21262d;" onclick="saveConfig()" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
        // ============================================
        const settings = {
            sound: true,
            notification: true,
            importantOnly: true
        };

        const analysisState = {
            technical: { score: 0, direction: 'neutral', factors: [] },
            news: { score: 0, direction: 'neutral', items: [] },
            calendar: { score: 0, direction: 'neutral', events: [] },
            total: { score: 0, direction: 'neutral' }
        };

        let lastSignal = null;
        let signalHistory = [];
        let historyData = [];
        let currentTf = 60;
        let useProxy = false;
        let autoUpdateInterval = null;
        let countdownInterval = null;
        let countdownSeconds = 30;
        let currentChart = null;
        let candleSeries = null;
        let lastCandleTime = 0;
        let allNews = [];
        let allCalendarEvents = [];
        let currentNewsFilter = 'all';
        let currentCalendarFilter = 'all';

        const TICKER = "SiH6";

        const tfMap = {
            1: 1, 10: 10, 60: 60, 240: 24, 1440: 'D', 10080: 'W'
        };

        // ============================================
        // –ó–í–£–ö–û–í–´–ï –°–ò–ì–ù–ê–õ–´
        // ============================================
        function playSignalSound(type) {
            if (!settings.sound) return;

            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                const now = audioContext.currentTime;

                if (type === 'buy') {
                    oscillator.frequency.setValueAtTime(440, now);
                    oscillator.frequency.setValueAtTime(554, now + 0.1);
                    oscillator.frequency.setValueAtTime(659, now + 0.2);
                    gainNode.gain.setValueAtTime(0.3, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    oscillator.start(now);
                    oscillator.stop(now + 0.5);
                } else if (type === 'sell') {
                    oscillator.frequency.setValueAtTime(659, now);
                    oscillator.frequency.setValueAtTime(554, now + 0.1);
                    oscillator.frequency.setValueAtTime(440, now + 0.2);
                    gainNode.gain.setValueAtTime(0.3, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    oscillator.start(now);
                    oscillator.stop(now + 0.5);
                } else {
                    oscillator.frequency.setValueAtTime(523, now);
                    gainNode.gain.setValueAtTime(0.2, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    oscillator.start(now);
                    oscillator.stop(now + 0.2);
                }
            } catch (e) {
                console.log('Audio not available');
            }
        }

        // ============================================
        // –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
        // ============================================
        function showNotification(signal, price, reason, confidence) {
            if (settings.importantOnly && signal === '–î–ï–†–ñ–ê–¢–¨') return;

            const container = document.getElementById('notificationContainer');

            const icons = {
                '–ü–û–ö–£–ü–ö–ê': '',
                '–ü–†–û–î–ê–ñ–ê': '',
                '–î–ï–†–ñ–ê–¢–¨': '‚è∏Ô∏è'
            };

            const titles = {
                '–ü–û–ö–£–ü–ö–ê': '–°–∏–≥–Ω–∞–ª –Ω–∞ –ü–û–ö–£–ü–ö–£',
                '–ü–†–û–î–ê–ñ–ê': '–°–∏–≥–Ω–∞–ª –Ω–∞ –ü–†–û–î–ê–ñ–£',
                '–î–ï–†–ñ–ê–¢–¨': '–°–∏–≥–Ω–∞–ª –î–ï–†–ñ–ê–¢–¨'
            };

            const notification = document.createElement('div');
            notification.className = `notification ${signal === '–ü–û–ö–£–ü–ö–ê' ? 'buy' : signal === '–ü–†–û–î–ê–ñ–ê' ? 'sell' : ''}`;
            notification.innerHTML = `
                <div class="notification-icon">${icons[signal]}</div>
                <div class="notification-content">
                    <div class="notification-title">${titles[signal]} (${confidence}%)</div>
                    <div class="notification-text">–¶–µ–Ω–∞: ${price.toFixed(2)} | ${reason.substring(0, 60)}...</div>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 10000);

            container.appendChild(notification);
            playSignalSound(signal === '–ü–û–ö–£–ü–ö–ê' ? 'buy' : signal === '–ü–†–û–î–ê–ñ–ê' ? 'sell' : 'hold');

            addToSignalHistory(signal, price, confidence);
        }

        function addToSignalHistory(signal, price, confidence) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

            signalHistory.unshift({
                time: timeStr,
                signal: signal,
                price: price,
                confidence: confidence,
                timestamp: now.getTime()
            });

            if (signalHistory.length > 20) {
                signalHistory = signalHistory.slice(0, 20);
            }

            updateSignalHistoryUI();
        }

        function updateSignalHistoryUI() {
            const container = document.getElementById('signalHistory');

            if (signalHistory.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #8b949e; font-size: 12px; padding: 20px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
                return;
            }

            container.innerHTML = signalHistory.map(item => `
                <div class="signal-history-item ${item.signal === '–ü–û–ö–£–ü–ö–ê' ? 'buy' : item.signal === '–ü–†–û–î–ê–ñ–ê' ? 'sell' : 'hold'}">
                    <span class="signal-history-time">${item.time}</span>
                    <span class="signal-history-signal">${item.signal}</span>
                    <span class="signal-history-price">${item.price.toFixed(2)}</span>
                </div>
            `).join('');
        }

        // ============================================
        // –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó
        // ============================================
        function calculateTechnicalAnalysis(data) {
            if (!data || data.length < 50) {
                return { score: 0, direction: 'neutral', factors: [] };
            }

            const closes = data.map(d => d.close);
            const factors = [];
            let totalScore = 0;

            // RSI
            const rsi = calculateRSI(closes, 14);
            const lastRsi = rsi[rsi.length - 1];
            
            let rsiScore = 0;
            let rsiDirection = 'neutral';
            if (lastRsi < 30) {
                rsiScore = 30;
                rsiDirection = 'bullish';
                factors.push({ name: 'RSI –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω', score: 30, direction: 'bullish' });
            } else if (lastRsi > 70) {
                rsiScore = -30;
                rsiDirection = 'bearish';
                factors.push({ name: 'RSI –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω', score: -30, direction: 'bearish' });
            } else if (lastRsi < 45) {
                rsiScore = 10;
                factors.push({ name: 'RSI –±–ª–∏–∂–µ –∫ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏', score: 10, direction: 'bullish' });
            } else if (lastRsi > 55) {
                rsiScore = -10;
                factors.push({ name: 'RSI –±–ª–∏–∂–µ –∫ –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏', score: -10, direction: 'bearish' });
            }
            totalScore += rsiScore;

            // MACD
            const macd = calculateMACD(closes);
            const lastMacd = macd.histogram[macd.histogram.length - 1];
            const prevMacd = macd.histogram[macd.histogram.length - 2];

            let macdScore = 0;
            if (lastMacd > 0 && prevMacd <= 0) {
                macdScore = 25;
                factors.push({ name: 'MACD –ø–µ—Ä–µ—Å—ë–∫ –Ω–æ–ª—å –≤–≤–µ—Ä—Ö', score: 25, direction: 'bullish' });
            } else if (lastMacd < 0 && prevMacd >= 0) {
                macdScore = -25;
                factors.push({ name: 'MACD –ø–µ—Ä–µ—Å—ë–∫ –Ω–æ–ª—å –≤–Ω–∏–∑', score: -25, direction: 'bearish' });
            } else if (lastMacd > 0) {
                macdScore = 10;
                factors.push({ name: 'MACD –≤—ã—à–µ –Ω—É–ª—è', score: 10, direction: 'bullish' });
            } else {
                macdScore = -10;
                factors.push({ name: 'MACD –Ω–∏–∂–µ –Ω—É–ª—è', score: -10, direction: 'bearish' });
            }
            totalScore += macdScore;

            // EMA
            const ema20 = calculateEMA(closes, 20);
            const ema50 = calculateEMA(closes, 50);
            const lastEma20 = ema20[ema20.length - 1];
            const lastEma50 = ema50[ema50.length - 1];
            const lastPrice = closes[closes.length - 1];

            let emaScore = 0;
            if (lastEma20 > lastEma50 && lastPrice > lastEma20) {
                emaScore = 20;
                factors.push({ name: '–¶–µ–Ω–∞ –≤—ã—à–µ EMA20 > EMA50', score: 20, direction: 'bullish' });
            } else if (lastEma20 < lastEma50 && lastPrice < lastEma20) {
                emaScore = -20;
                factors.push({ name: '–¶–µ–Ω–∞ –Ω–∏–∂–µ EMA20 < EMA50', score: -20, direction: 'bearish' });
            } else if (lastPrice > lastEma20) {
                emaScore = 10;
                factors.push({ name: '–¶–µ–Ω–∞ –≤—ã—à–µ EMA20', score: 10, direction: 'bullish' });
            } else {
                emaScore = -10;
                factors.push({ name: '–¶–µ–Ω–∞ –Ω–∏–∂–µ EMA20', score: -10, direction: 'bearish' });
            }
            totalScore += emaScore;

            // –¢—Ä–µ–Ω–¥ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º —Å–≤–µ—á–∞–º
            const recentCloses = closes.slice(-10);
            const trendUp = recentCloses.every((c, i) => i === 0 || c >= recentCloses[i-1] * 0.998);
            const trendDown = recentCloses.every((c, i) => i === 0 || c <= recentCloses[i-1] * 1.002);

            if (trendUp) {
                totalScore += 15;
                factors.push({ name: '–í–æ—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥', score: 15, direction: 'bullish' });
            } else if (trendDown) {
                totalScore -= 15;
                factors.push({ name: '–ù–∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥', score: -15, direction: 'bearish' });
            }

            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º score –æ—Ç -100 –¥–æ 100
            totalScore = Math.max(-100, Math.min(100, totalScore));

            let direction = 'neutral';
            if (totalScore > 20) direction = 'bullish';
            else if (totalScore < -20) direction = 'bearish';

            return {
                score: totalScore,
                direction: direction,
                factors: factors,
                rsi: lastRsi,
                macd: macd,
                ema20: lastEma20,
                ema50: lastEma50
            };
        }

        function calculateRSI(prices, period) {
            const rsi = [];
            let gains = 0, losses = 0;

            for (let i = 1; i <= period; i++) {
                const diff = prices[i] - prices[i - 1];
                if (diff > 0) gains += diff;
                else losses -= diff;
            }

            let avgGain = gains / period;
            let avgLoss = losses / period;

            rsi.push(100 - (100 / (1 + avgGain / avgLoss)));

            for (let i = period + 1; i < prices.length; i++) {
                const diff = prices[i] - prices[i - 1];
                avgGain = (avgGain * (period - 1) + (diff > 0 ? diff : 0)) / period;
                avgLoss = (avgLoss * (period - 1) + (diff < 0 ? -diff : 0)) / period;
                rsi.push(100 - (100 / (1 + avgGain / avgLoss)));
            }

            return rsi;
        }

        function calculateEMA(prices, period) {
            const ema = [];
            const multiplier = 2 / (period + 1);

            let sum = 0;
            for (let i = 0; i < period; i++) {
                sum += prices[i];
            }
            ema.push(sum / period);

            for (let i = period; i < prices.length; i++) {
                ema.push((prices[i] - ema[ema.length - 1]) * multiplier + ema[ema.length - 1]);
            }

            return ema;
        }

        function calculateMACD(prices) {
            const ema12 = calculateEMA(prices, 12);
            const ema26 = calculateEMA(prices, 26);

            const macdLine = [];
            for (let i = 0; i < ema12.length && i < ema26.length; i++) {
                macdLine.push(ema12[i] - ema26[i]);
            }

            const signalLine = calculateEMA(macdLine, 9);
            const histogram = [];

            for (let i = 0; i < macdLine.length && i < signalLine.length; i++) {
                histogram.push(macdLine[i] - signalLine[i]);
            }

            return { macdLine, signalLine, histogram };
        }

        // ============================================
        // –≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–ò–ô –ö–ê–õ–ï–ù–î–ê–†–¨ (–†–ï–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï)
        // ============================================

        // –ò–∑–≤–µ—Å—Ç–Ω—ã–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ 2026)
        const KNOWN_EVENTS_2026 = {
            // –°–®–ê - –ø–µ—Ä–≤–∞—è –ø—è—Ç–Ω–∏—Ü–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ (NFP)
            'us_nfp': { name: 'Non-Farm Payrolls', country: 'US', currency: 'USD', impact: 'high' },
            // –ó–∞—Å–µ–¥–∞–Ω–∏—è –§–†–° (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ –¥–∞—Ç—ã - —É—Ç–æ—á–Ω—è–π—Ç–µ)
            'us_fomc': { name: 'FOMC Meeting', country: 'US', currency: 'USD', impact: 'high' },
            // –†–æ—Å—Å–∏—è - –∑–∞—Å–µ–¥–∞–Ω–∏—è –¶–ë –†–§
            'ru_cbr': { name: '–ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§', country: 'RU', currency: 'RUB', impact: 'high' },
            // –°–®–ê - –∏–Ω—Ñ–ª—è—Ü–∏—è
            'us_cpi': { name: 'CPI –°–®–ê', country: 'US', currency: 'USD', impact: 'high' },
            'us_ppi': { name: 'PPI –°–®–ê', country: 'US', currency: 'USD', impact: 'medium' },
            // –°–®–ê - —Ä–æ–∑–Ω–∏—á–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏
            'us_retail': { name: 'Retail Sales', country: 'US', currency: 'USD', impact: 'medium' },
            // –°–®–ê - –í–í–ü
            'us_gdp': { name: 'GDP Advance', country: 'US', currency: 'USD', impact: 'high' },
            // –†–æ—Å—Å–∏—è - –∏–Ω—Ñ–ª—è—Ü–∏—è
            'ru_inflation': { name: '–ò–Ω—Ñ–ª—è—Ü–∏—è –†–§', country: 'RU', currency: 'RUB', impact: 'high' },
            // PMI
            'us_manufacturing': { name: 'ISM Manufacturing', country: 'US', currency: 'USD', impact: 'medium' },
            'ru_manufacturing': { name: 'PMI –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –†–§', country: 'RU', currency: 'RUB', impact: 'medium' }
        };

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–ª–∏–∂–∞–π—à–∏–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
        function generateUpcomingEvents() {
            const now = new Date();
            const events = [];

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–ª–∏–∂–∞–π—à—É—é –ø—è—Ç–Ω–∏—Ü—É (NFP)
            const nextFriday = getNextFriday(now);
            const daysUntilFriday = Math.ceil((nextFriday - now) / (1000 * 60 * 60 * 24));

            // NFP - –ø–µ—Ä–≤–∞—è –ø—è—Ç–Ω–∏—Ü–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞
            events.push({
                id: 'nfp_1',
                time: nextFriday,
                country: 'US',
                currency: 'USD',
                name: 'Non-Farm Payrolls',
                impact: 'high',
                forecast: '~180K',
                previous: '151K',
                actual: null,
                description: 'NFP - –∑–∞–Ω—è—Ç–æ—Å—Ç—å –≤ –Ω–µ—Å–µ–ª—å—Å–∫–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ–º —Å–µ–∫—Ç–æ—Ä–µ –°–®–ê'
            });

            // –ó–∞—Å–µ–¥–∞–Ω–∏–µ –§–†–° - –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ –∫–∞–∂–¥—ã–µ 6 –Ω–µ–¥–µ–ª—å
            const nextFOMC = getNextFOMC(now);
            events.push({
                id: 'fomc_1',
                time: nextFOMC,
                country: 'US',
                currency: 'USD',
                name: 'FOMC Meeting',
                impact: 'high',
                forecast: '4.50%',
                previous: '4.50%',
                actual: null,
                description: '–ó–∞—Å–µ–¥–∞–Ω–∏–µ –ö–æ–º–∏—Ç–µ—Ç–∞ –ø–æ –æ—Ç–∫—Ä—ã—Ç—ã–º —Ä—ã–Ω–∫–∞–º –§–†–°'
            });

            // –ë–ª–∏–∂–∞–π—à–µ–µ –∑–∞—Å–µ–¥–∞–Ω–∏–µ –¶–ë –†–§
            const nextCBR = getNextCBR(now);
            events.push({
                id: 'cbr_1',
                time: nextCBR,
                country: 'RU',
                currency: 'RUB',
                name: '–ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§',
                impact: 'high',
                forecast: '21.00%',
                previous: '21.00%',
                actual: null,
                description: '–†–µ—à–µ–Ω–∏–µ –ø–æ –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–µ –ë–∞–Ω–∫–∞ –†–æ—Å—Å–∏–∏'
            });

            // CPI –°–®–ê - –æ–±—ã—á–Ω–æ 10-15 —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞
            const nextCPI = getNextCPI(now);
            if (nextCPI) {
                events.push({
                    id: 'cpi_us',
                    time: nextCPI,
                    country: 'US',
                    currency: 'USD',
                    name: 'CPI –°–®–ê (–º/–º)',
                    impact: 'high',
                    forecast: '0.3%',
                    previous: '0.4%',
                    actual: null,
                    description: '–ò–Ω–¥–µ–∫—Å –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å—Å–∫–∏—Ö —Ü–µ–Ω –°–®–ê'
                });
            }

            // Retail Sales - –æ–±—ã—á–Ω–æ 15-17 —á–∏—Å–ª–∞
            const nextRetail = getNextRetail(now);
            if (nextRetail) {
                events.push({
                    id: 'retail_us',
                    time: nextRetail,
                    country: 'US',
                    currency: 'USD',
                    name: 'Retail Sales',
                    impact: 'medium',
                    forecast: '0.4%',
                    previous: '0.2%',
                    actual: null,
                    description: '–†–æ–∑–Ω–∏—á–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏ –≤ –°–®–ê'
                });
            }

            // PMI Manufacturing –†–§ - –ø–µ—Ä–≤—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
            const nextRU_PMI = getNextMonthStart(now);
            events.push({
                id: 'pmi_ru',
                time: nextRU_PMI,
                country: 'RU',
                currency: 'RUB',
                name: 'PMI –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –†–§',
                impact: 'medium',
                forecast: '52.0',
                previous: '53.1',
                actual: null,
                description: '–ò–Ω–¥–µ–∫—Å –¥–µ–ª–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–º —Å–µ–∫—Ç–æ—Ä–µ –†–§'
            });

            // –ù–µ–¥–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ jobless claims (—á–µ—Ç–≤–µ—Ä–≥)
            const nextJobless = getNextThursday(now);
            events.push({
                id: 'jobless',
                time: nextJobless,
                country: 'US',
                currency: 'USD',
                name: 'Unemployment Claims',
                impact: 'medium',
                forecast: '220K',
                previous: '221K',
                actual: null,
                description: '–ü–µ—Ä–≤–∏—á–Ω—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ—Å–æ–±–∏–µ –ø–æ –±–µ–∑—Ä–∞–±–æ—Ç–∏—Ü–µ'
            });

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
            events.sort((a, b) => a.time - b.time);

            return events;
        }

        function getNextFriday(date) {
            const result = new Date(date);
            const dayOfWeek = result.getDay();
            const daysUntilFriday = dayOfWeek === 5 ? 7 : (5 - dayOfWeek + 7) % 7 || 7;
            result.setDate(result.getDate() + daysUntilFriday);
            result.setHours(15, 30, 0, 0); // 15:30 –ú–°–ö (8:30 EST)
            return result;
        }

        function getNextThursday(date) {
            const result = new Date(date);
            const dayOfWeek = result.getDay();
            const daysUntilThursday = dayOfWeek <= 4 ? 4 - dayOfWeek : 4 - dayOfWeek + 7;
            result.setDate(result.getDate() + daysUntilThursday);
            result.setHours(15, 30, 0, 0);
            return result;
        }

        function getNextFOMC(date) {
            // –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ - –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω—è—Ç—å –Ω–∞ —Å–∞–π—Ç–µ –§–†–°
            const result = new Date(date);
            result.setDate(result.getDate() + 42); // ~6 –Ω–µ–¥–µ–ª—å
            result.setHours(21, 0, 0, 0);
            return result;
        }

        function getNextCBR(date) {
            // –ë–ª–∏–∂–∞–π—à–µ–µ –∑–∞—Å–µ–¥–∞–Ω–∏–µ –¶–ë –†–§ - –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü
            const result = new Date(date);
            result.setDate(result.getDate() + 14); // ~2 –Ω–µ–¥–µ–ª–∏
            result.setHours(13, 30, 0, 0);
            return result;
        }

        function getNextCPI(date) {
            const result = new Date(date);
            const day = result.getDate();
            if (day < 12) {
                result.setDate(12);
            } else {
                result.setMonth(result.getMonth() + 1);
                result.setDate(12);
            }
            result.setHours(15, 30, 0, 0);
            return result;
        }

        function getNextRetail(date) {
            const result = new Date(date);
            const day = result.getDate();
            if (day < 15) {
                result.setDate(15);
            } else {
                result.setMonth(result.getMonth() + 1);
                result.setDate(15);
            }
            result.setHours(15, 30, 0, 0);
            return result;
        }

        function getNextMonthStart(date) {
            const result = new Date(date);
            result.setMonth(result.getMonth() + 1);
            result.setDate(1);
            result.setHours(10, 0, 0, 0);
            return result;
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        async function fetchEconomicCalendar() {
            const container = document.getElementById('calendarList');
            container.innerHTML = '<div style="text-align: center; color: #8b949e; padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...</div>';

            try {
                // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ API
                const events = await fetchFromFreeCalendarAPI();
                if (events && events.length > 0) {
                    allCalendarEvents = events;
                } else {
                    // Fallback –Ω–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
                    allCalendarEvents = generateUpcomingEvents();
                }
            } catch (e) {
                console.log('Using known events:', e);
                allCalendarEvents = generateUpcomingEvents();
            }

            renderCalendar(allCalendarEvents);
            updateCalendarInfluence(allCalendarEvents);
        }

        // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ API
        async function fetchFromFreeCalendarAPI() {
            // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Alpha Vantage (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π tier)
            // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á–∞, –Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ–º–æ
            // –ó–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ–º Known Events –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫
            return null;
        }

        function renderCalendar(events) {
            const container = document.getElementById('calendarList');
            document.getElementById('calendarCount').textContent = events.length;

            if (events.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #8b949e; padding: 20px;">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</div>';
                return;
            }

            container.innerHTML = events.map(event => {
                const timeStr = event.time.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const countryFlag = event.country === 'RU' ? 'üá∑üá∫' : 'üá∫üá∏';

                return `
                    <div class="calendar-item ${event.impact}">
                        <div class="calendar-time">
                            ${timeStr}
                            <span class="calendar-country">${countryFlag} ${event.currency}</span>
                        </div>
                        <div class="calendar-event">${event.name}</div>
                        <div class="calendar-values">
                            <div class="calendar-value">
                                <span class="calendar-value-label">–ü—Ä–æ–≥–Ω–æ–∑</span>
                                <span class="calendar-value-num">${event.forecast}</span>
                            </div>
                            <div class="calendar-value">
                                <span class="calendar-value-label">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ</span>
                                <span class="calendar-value-num">${event.previous}</span>
                            </div>
                        </div>
                        <span class="calendar-impact impact-${event.impact}">${
                            event.impact === 'high' ? '–í–´–°–û–ö–û–ï –í–õ–ò–Ø–ù–ò–ï' :
                            event.impact === 'medium' ? '–°–†–ï–î–ù–ï–ï –í–õ–ò–Ø–ù–ò–ï' : '–ù–ò–ó–ö–û–ï –í–õ–ò–Ø–ù–ò–ï'
                        }</span>
                    </div>
                `;
            }).join('');
        }

        function updateCalendarInfluence(events) {
            const now = new Date();
            let score = 0;
            let relevantEvents = [];

            // –°–º–æ—Ç—Ä–∏–º –Ω–∞ —Å–æ–±—ã—Ç–∏—è –±–ª–∏–∂–∞–π—à–∏—Ö 24 —á–∞—Å–æ–≤
            events.forEach(event => {
                const hoursDiff = (event.time - now) / (1000 * 60 * 60);

                if (hoursDiff >= -2 && hoursDiff <= 24) {
                    let eventScore = 0;
                    const impactWeight = event.impact === 'high' ? 30 : event.impact === 'medium' ? 15 : 5;

                    // –î–ª—è —Ä—É–±–ª—ë–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å–æ–±—ã—Ç–∏—è –†–§ –≤–∞–∂–Ω–µ–µ
                    if (event.currency === 'RUB') {
                        eventScore = impactWeight;
                    } else if (event.currency === 'USD') {
                        // USD —Å–æ–±—ã—Ç–∏—è –≤–ª–∏—è—é—Ç —á–µ—Ä–µ–∑ –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞
                        eventScore = impactWeight * 0.7;
                    }

                    // –ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è –≤–∞–∂–Ω–µ–µ
                    if (hoursDiff <= 2) eventScore *= 1.5;
                    else if (hoursDiff <= 6) eventScore *= 1.2;

                    relevantEvents.push({
                        ...event,
                        score: eventScore,
                        hoursDiff: hoursDiff
                    });
                }
            });

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π
            relevantEvents.forEach(event => {
                if (event.name.includes('Rate') || event.name.includes('—Å—Ç–∞–≤–∫–∞')) {
                    // –°—Ç–∞–≤–∫–∏ - –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π
                    score += event.score * 0.5; // –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ –¥–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
                } else {
                    score += event.score * 0.3;
                }
            });

            analysisState.calendar.score = Math.min(100, score);
            analysisState.calendar.events = relevantEvents;

            updateInfluenceUI();
        }

        function filterCalendar(type, event) {
            currentCalendarFilter = type;

            document.querySelectorAll('#calendarContainer .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }

            let filtered = allCalendarEvents;

            if (type === 'high') {
                filtered = allCalendarEvents.filter(e => e.impact === 'high');
            } else if (type === 'medium') {
                filtered = allCalendarEvents.filter(e => e.impact === 'medium');
            } else if (type === 'usd') {
                filtered = allCalendarEvents.filter(e => e.currency === 'USD');
            } else if (type === 'rub') {
                filtered = allCalendarEvents.filter(e => e.currency === 'RUB');
            }

            renderCalendar(filtered);
        }

        function refreshCalendar() {
            fetchEconomicCalendar();
        }

        // ============================================
        // –ù–û–í–û–°–¢–ù–û–ô –§–û–ù (–†–ï–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï)
        // ============================================

        // RSS —Ñ–∏–¥—ã –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
        const RSS_FEEDS = [
            'https://ru.investing.com/rss/news_25.rss',  // –†–æ—Å—Å–∏—è
            'https://lenta.ru/rss/news',                  // –õ–µ–Ω—Ç–∞.—Ä—É
            'https://www.vedomosti.ru/rss/articles'        // –í–µ–¥–æ–º–æ—Å—Ç–∏
        ];

        // –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π (–¥–ª—è Si - —Ä—É–±–ª—å/–¥–æ–ª–ª–∞—Ä)
const KEYWORDS = {
    // üìà –ë—ã—á—å–∏ –¥–ª—è Si (—Ä—É–±–ª—å —Å–ª–∞–±–µ–µ—Ç ‚Üí Si —Ä–∞—Å—Ç—ë—Ç)
    bullish: [
        // –í–æ–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ —ç—Å–∫–∞–ª–∞—Ü–∏—è
        '–∞—Ç–∞–∫–∞', '–≤—Å—É', '–æ–±—Å—Ç—Ä–µ–ª', '–≤–æ–µ–Ω–Ω—ã–µ', '–¥–µ–π—Å—Ç–≤–∏—è', '–∫–æ–Ω—Ñ–ª–∏–∫—Ç',
        '–±–µ—Å–ø–æ—Ä—è–¥–∫–∏', '–Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–µ', '–ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–µ', '–∂–µ—Ä—Ç–≤—ã', '–≤–æ–π—Å–∫–∞',
        '–≤—Ç–æ—Ä–∂–µ–Ω–∏–µ', '–±–æ–π', '–±–æ–º–±–∞—Ä–¥–∏—Ä–æ–≤–∫–∞', '–±–µ–∂–µ–Ω—Ü—ã', '–º–æ–±–∏–ª–∏–∑–∞—Ü–∏—è',
        '—É–≥—Ä–æ–∑–∞', '–Ω–∞–ø—Ä—è–∂—ë–Ω–Ω–æ—Å—Ç—å', '–ø—Ä–æ–≤–æ–∫–∞—Ü–∏—è', '–∏–Ω—Ü–∏–¥–µ–Ω—Ç', '—á–ø',
        '–∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞', '—Ç–µ—Ä–∞–∫—Ç', '–≤–∑—Ä—ã–≤', '–ø–æ–∂–∞—Ä', '–∫—Ä—É—à–µ–Ω–∏–µ',
        '–¥–æ–Ω–±–∞—Å—Å', '–∫—Ä—ã–º', '–∫–∏–µ–≤', '—É–∫—Ä–∞–∏–Ω–∞', '–∑–µ–ª–µ–Ω—Å–∫–∏–π',

        // –°–∞–Ω–∫—Ü–∏–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
        '—Å–∞–Ω–∫—Ü–∏–∏', '–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è', '–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞', '–∑–∞–ø—Ä–µ—Ç', '—ç–º–±–∞—Ä–≥–æ',
        '–±–æ–π–∫–æ—Ç', '–∏–∑–æ–ª—è—Ü–∏—è', '–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ', 'swift', '–∑–∞–º–æ—Ä–æ–∑–∫–∞',
        '–∞–∫—Ç–∏–≤—ã', '–∞—Ä–µ—Å—Ç', '–∫–æ–Ω—Ñ–∏—Å–∫–∞—Ü–∏—è',

        // –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
        '–∏–Ω—Ñ–ª—è—Ü–∏—è', '–∫—Ä–∏–∑–∏—Å', '–¥–µ—Ñ–∏—Ü–∏—Ç', '—Ä–µ—Ü–µ—Å—Å–∏—è', '–¥–µ–≤–∞–ª—å–≤–∞—Ü–∏—è',
        '–æ–±–≤–∞–ª', '–ø–∞–¥–µ–Ω–∏–µ', '—Å–Ω–∏–∂–µ–Ω–∏–µ', '—É—Ö—É–¥—à–µ–Ω–∏–µ', '–Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å',
        '–æ—Ç—Ç–æ–∫ –∫–∞–ø–∏—Ç–∞–ª–∞', '–±–µ–≥—Å—Ç–≤–æ', '–¥–µ—Ñ–æ–ª—Ç', '—Ä–∏—Å–∫', '—Å—Ç–∞–≥–Ω–∞—Ü–∏—è',
        '–±–µ–∑—Ä–∞–±–æ—Ç–∏—Ü–∞', '–±–µ–¥–Ω–æ—Å—Ç—å', '–Ω–∏—â–µ—Ç–∞', '–æ–±–Ω–∏—â–∞–Ω–∏–µ',

        // –ù–µ—Ñ—Ç—å –∏ —Å—ã—Ä—å—ë (–ø–∞–¥–µ–Ω–∏–µ —Ü–µ–Ω)
        '–Ω–µ—Ñ—Ç—å –ø–∞–¥–∞–µ—Ç', '—Å–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω –Ω–∞ –Ω–µ—Ñ—Ç—å', '–æ–±–≤–∞–ª –Ω–µ—Ñ—Ç–∏',
        'brent —É–ø–∞–ª', '–Ω–µ—Ñ—Ç—å –¥–µ—à–µ–≤–µ–µ—Ç', '–º–∞—Ä–∫–∞ urals', '—Å—ã—Ä—å—ë –¥–µ—à–µ–≤–µ–µ—Ç',

        // –î–æ–ª–ª–∞—Ä –∏ –≤–∞–ª—é—Ç–∞ (—Ä–æ—Å—Ç –¥–æ–ª–ª–∞—Ä–∞)
        '–¥–æ–ª–ª–∞—Ä —Ä–∞—Å—Ç—ë—Ç', '–¥–æ–ª–ª–∞—Ä –¥–æ—Ä–æ–∂–∞–µ—Ç', 'usd –≤—ã—Ä–æ—Å', '–∏–Ω–¥–µ–∫—Å –¥–æ–ª–ª–∞—Ä–∞',
        'dxy', 'dollar index', '–µ–≤—Ä–æ –¥–µ—à–µ–≤–µ–µ—Ç', '—Ä—É–±–ª—å —Å–ª–∞–±–µ–µ—Ç',
        '—Ä—É–±–ª—å –ø–∞–¥–∞–µ—Ç', '–æ—Å–ª–∞–±–ª–µ–Ω–∏–µ —Ä—É–±–ª—è', '–Ω–∏–∂–µ 100', '–Ω–∏–∂–µ 110',

        // –ú–æ–Ω–µ—Ç–∞—Ä–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –°–®–ê/–º–∏—Ä–∞ (—É–∂–µ—Å—Ç–æ—á–µ–Ω–∏–µ)
        '—Ñ—Ä—Å', 'federal reserve', '–ø–æ–≤—ã—à–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ —Ñ—Ä—Å', '—Ç–∞pering',
        '—É–∂–µ—Å—Ç–æ—á–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏', '—è—Å—Ç—Ä–µ–±–∏–Ω—ã–π', '–∏–Ω—Ñ–ª—è—Ü–∏—è –≤ —Å—à–∞',
        '–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ —Å—à–∞', '–¥–∂–µ—Ä–æ–º –ø–∞—É—ç–ª–ª',

        // –ü—Ä–æ—á–∏–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
        '–≤–æ–π–Ω–∞', '–º–æ–±–∏–ª–∏–∑–∞—Ü–∏—è', '—Ç—Ä–µ–≤–æ–≥–∞', '–æ–ø–∞—Å–µ–Ω–∏—è', '–ø–µ—Å—Å–∏–º–∏–∑–º',
        '—à–æ–∫', '–ø—Ä–æ–≤–∞–ª', '–∫—Ä–∞—Ö', '–±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ', '–¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è'
    ],

    // üìâ –ú–µ–¥–≤–µ–∂—å–∏ –¥–ª—è Si (—Ä—É–±–ª—å —É–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è ‚Üí Si –ø–∞–¥–∞–µ—Ç)
    bearish: [
        // –†–æ—Å—Ç —Ü–µ–Ω –Ω–∞ –Ω–µ—Ñ—Ç—å –∏ —Å—ã—Ä—å—ë
        '–Ω–µ—Ñ—Ç—å —Ä–∞—Å—Ç—ë—Ç', '–Ω–µ—Ñ—Ç—å –¥–æ—Ä–æ–∂–∞–µ—Ç', '—Ä–æ—Å—Ç —Ü–µ–Ω –Ω–∞ –Ω–µ—Ñ—Ç—å', 'brent —Ä–∞—Å—Ç—ë—Ç',
        '–Ω–µ—Ñ—Ç—å –≤–≤–µ—Ä—Ö', '–Ω–µ—Ñ—Ç—å –ø–æ–¥–æ—Ä–æ–∂–∞–ª–∞', '—Å—ã—Ä—å—ë –¥–æ—Ä–æ–∂–∞–µ—Ç', '–≥–∞–∑ –¥–æ—Ä–æ–∂–∞–µ—Ç',

        // –ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —É—Å–ø–µ—Ö–∏ –†–æ—Å—Å–∏–∏
        '—Ä–æ—Å—Ç –≤–≤–ø', '–ø—Ä–æ—Ñ–∏—Ü–∏—Ç', '—ç–∫—Å–ø–æ—Ä—Ç', '–∏–º–ø–æ—Ä—Ç–æ–∑–∞–º–µ—â–µ–Ω–∏–µ',
        '–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å', '–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ', '—É—Ä–æ–∂–∞–π', '—Ä–µ–∫–æ—Ä–¥',
        '–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', '–ø–æ–¥—ä—ë–º', '—Ä–æ—Å—Ç', '—É–ª—É—á—à–µ–Ω–∏–µ', '–ø–æ–∑–∏—Ç–∏–≤',
        '–æ–ø—Ç–∏–º–∏–∑–º', '–¥–∏–Ω–∞–º–∏–∫–∞', '—Ä–∞–∑–≤–∏—Ç–∏–µ',

        // –ë—é–¥–∂–µ—Ç –∏ –Ω–∞–ª–æ–≥–∏
        '–±—é–¥–∂–µ—Ç', '–¥–æ—Ö–æ–¥—ã', '–Ω–µ—Ñ—Ç–µ–≥–∞–∑–æ–≤—ã–µ –¥–æ—Ö–æ–¥—ã', '–Ω–∞–ª–æ–≥–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥',
        '–Ω–∞–ª–æ–≥–∏', '–º–∏–Ω—Ñ–∏–Ω', '–∫–∞–∑–Ω–∞—á–µ–π—Å—Ç–≤–æ', '—Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç',
        '—Å–±–æ—Ä—ã', '–ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è',

        // –£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ä—É–±–ª—è
        '—Ä—É–±–ª—å —É–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è', '—Ä—É–±–ª—å —Ä–∞—Å—Ç—ë—Ç', '–¥–æ–ª–ª–∞—Ä –ø–∞–¥–∞–µ—Ç',
        '—Ä—É–±–ª—å –¥–æ—Ä–æ–∂–∞–µ—Ç', '–Ω–∞—Ü–≤–∞–ª—é—Ç–∞', '–∫—É—Ä—Å —Ä—É–±–ª—è', '—É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ',

        // –î–µ–π—Å—Ç–≤–∏—è –¶–ë –†–§ (–ø–æ–≤—ã—à–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏)
        '—Ü–±', '—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–Ω–∫', '–∫–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞', '–ø–æ–≤—ã—à–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏',
        '—Å—Ç–∞–≤–∫–∞ –ø–æ–≤—ã—à–µ–Ω–∞', '–∂–µ—Å—Ç–∫–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞', '–∫—Ä–µ–¥–∏—Ç—ã –¥–æ—Ä–æ–∂–∞—é—Ç',
        '—ç–ª—å–≤–∏—Ä–∞ –Ω–∞–±–∏—É–ª–ª–∏–Ω–∞', '—Å–æ–≤–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤ —Ü–±',

        // –ü—Ä–∏—Ç–æ–∫ –∫–∞–ø–∏—Ç–∞–ª–∞ –∏ —Ä–µ–∑–µ—Ä–≤—ã
        '–ø—Ä–∏—Ç–æ–∫ –∫–∞–ø–∏—Ç–∞–ª–∞', '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', '—Ä–µ–∑–µ—Ä–≤—ã', '–∑–æ–ª–æ—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ',
        '–∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª', '–≤–ª–æ–∂–µ–Ω–∏—è', '—Ñ–æ–Ω–¥—ã', '–ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–µ',

        // –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã
        '–ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', '–¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏', '—Å–¥–µ–ª–∫–∞', '—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ',
        '–ø–æ–º–æ—â—å', '–ø–æ–¥–¥–µ—Ä–∂–∫–∞', '–∫—Ä–µ–¥–∏—Ç', '—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ', '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏',

        // –°–Ω–∏–∂–µ–Ω–∏–µ –≥–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞–ø—Ä—è–∂—ë–Ω–Ω–æ—Å—Ç–∏
        '–¥–µ—ç—Å–∫–∞–ª–∞—Ü–∏—è', '–ø–µ—Ä–µ–º–∏—Ä–∏–µ', '–ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ –æ–≥–Ω—è', '–º–∏—Ä–Ω—ã–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã',
        '—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è', '—É—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ', '–∫–æ–Ω—Å–µ–Ω—Å—É—Å',

        // –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (—Å–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
        '–∏–Ω–¥–µ–∫—Å –¥–µ–ª–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', 'pmi', '–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–π —Å–µ–∫—Ç–æ—Ä',
        '—Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ', '—Ç–æ—Ä–≥–æ–≤–ª—è', '—Ä–æ–∑–Ω–∏—Ü–∞', '—Å–ø—Ä–æ—Å'
    ]
};

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–∞–∂–Ω–æ—Å—Ç–∏ –Ω–æ–≤–æ—Å—Ç–∏
        function getNewsImpact(title, description) {
            const text = (title + ' ' + (description || '')).toLowerCase();
            const highImpact = ['—Å–∞–Ω–∫—Ü–∏–∏', '–∫–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞', '—Ü–± —Ä—Ñ', '—Ñ—Ä—Å', 'federal reserve', '–Ω–µ—Ñ—Ç—å', 'brent', '–∏–Ω—Ñ–ª—è—Ü–∏—è'];
            const mediumImpact = ['—Ä—É–±–ª—å', '–¥–æ–ª–ª–∞—Ä', '—ç–∫–æ–Ω–æ–º–∏–∫–∞', '–±–∏—Ä–∂–∞', '–º–º–≤–±', '—Ä—ã–Ω–æ–∫'];

            for (const word of highImpact) {
                if (text.includes(word)) return 'high';
            }
            for (const word of mediumImpact) {
                if (text.includes(word)) return 'medium';
            }
            return 'low';
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –Ω–æ–≤–æ—Å—Ç–∏
        function getNewsSentiment(title, description) {
            const text = ((title || '') + ' ' + (description || '')).toLowerCase();

            let bullishScore = 0;
            let bearishScore = 0;

            for (const keyword of KEYWORDS.bullish) {
                if (text.includes(keyword)) bullishScore += 1;
            }
            for (const keyword of KEYWORDS.bearish) {
                if (text.includes(keyword)) bearishScore += 1;
            }

            if (bullishScore > bearishScore) return 'bullish';
            if (bearishScore > bullishScore) return 'bearish';
            return 'neutral';
        }

        async function fetchNews() {
            const container = document.getElementById('newsList');
            container.innerHTML = '<div style="text-align: center; color: #8b949e; padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</div>';

            const allFetchedNews = [];

            for (const rssUrl of RSS_FEEDS) {
                try {
                    const news = await fetchFromRSS(rssUrl);
                    allFetchedNews.push(...news);
                } catch (e) {
                    console.log(`Failed to fetch ${rssUrl}:`, e);
                }
            }

            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
            if (allFetchedNews.length === 0) {
                console.log('Using fallback news');
                const news = generateFallbackNews();
                allNews = news;
                renderNews(news);
                updateNewsInfluence(news);
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å–≤–µ–∂–∏–µ first)
            allFetchedNews.sort((a, b) => b.time - a.time);

            // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
            const now = new Date();
            const filteredNews = allFetchedNews.filter(n => {
                const hoursDiff = (now - n.time) / (1000 * 60 * 60);
                return hoursDiff <= 48; // 48 —á–∞—Å–æ–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            });

            allNews = filteredNews;
            renderNews(filteredNews);
            updateNewsInfluence(filteredNews);
        }

        async function fetchFromRSS(rssUrl) {
            const news = [];
            const encodedUrl = encodeURIComponent(rssUrl);
            const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodedUrl}`;

            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();

            if (data.status !== 'ok' || !data.items) {
                throw new Error('Invalid RSS data');
            }

            for (const item of data.items) {
                const pubDate = new Date(item.pubDate);
                const title = item.title || '';
                const description = item.description || '';

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞–∂–Ω–æ—Å—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
                const impact = getNewsImpact(title, description);
                const sentiment = getNewsSentiment(title, description);

                news.push({
                    id: Math.random().toString(36).substr(2, 9),
                    time: pubDate,
                    title: title.substring(0, 150),
                    text: description.replace(/<[^>]*>/g, '').substring(0, 200),
                    impact: impact,
                    sentiment: sentiment,
                    link: item.link
                });
            }

            return news;
        }

        function generateFallbackNews() {
            const now = new Date();
            // Fallback —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã - —É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
            const templates = [
                { title: '–¶–ë –†–§: –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏', sentiment: 'neutral', impact: 'high' },
                { title: '–ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ –Ω–∞ –ú–ú–í–ë', sentiment: 'neutral', impact: 'medium' },
                { title: '–¶–µ–Ω—ã –Ω–∞ –Ω–µ—Ñ—Ç—å Brent', sentiment: 'bearish', impact: 'high' }
            ];

            return templates.map((item, i) => ({
                id: i,
                time: new Date(now.getTime() - i * 3600000),
                title: item.title,
                text: '–î–∞–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã',
                impact: item.impact,
                sentiment: item.sentiment
            }));
        }

        function renderNews(news) {
            const container = document.getElementById('newsList');
            document.getElementById('newsCount').textContent = news.length;

            if (news.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #8b949e; padding: 20px;">–ù–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π</div>';
                return;
            }

            container.innerHTML = news.map(item => {
                const timeStr = item.time.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const sentimentLabel = {
                    'bullish': 'üìâ –ú–µ–¥–≤–µ–∂—å—è –¥–ª—è Si',
                    'bearish': 'üìà –ë—ã—á—å—è –¥–ª—è Si',
                    'neutral': '‚û°Ô∏è –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è'
                };

                return `
                    <div class="news-item ${item.impact}">
                        <div class="news-time">${timeStr}</div>
                        <div class="news-text"><strong>${item.title}</strong></div>
                        <div class="news-text" style="font-size: 12px; color: #8b949e; margin-top: 4px;">${item.text}</div>
                        <span class="news-sentiment sentiment-${item.sentiment}">${sentimentLabel[item.sentiment]}</span>
                    </div>
                `;
            }).join('');
        }

        function updateNewsInfluence(news) {
            let bullishScore = 0;
            let bearishScore = 0;

            const now = new Date();

            news.forEach(item => {
                const hoursDiff = (now - item.time) / (1000 * 60 * 60);
                const impactWeight = item.impact === 'high' ? 30 : item.impact === 'medium' ? 15 : 5;

                // –°–≤–µ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –≤–∞–∂–Ω–µ–µ
                const recencyMultiplier = Math.max(0.1, 1 - hoursDiff / 48);

                const score = impactWeight * recencyMultiplier;

                // –î–ª—è Si: bullish sentiment = —Ü–µ–Ω–∞ —Ä–∞—Å—Ç—ë—Ç (—Ä—É–±–ª—å —Å–ª–∞–±–µ–µ—Ç)
                // bearish sentiment = —Ü–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç (—Ä—É–±–ª—å —É–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è)
                if (item.sentiment === 'bullish') {
                    bullishScore += score;
                } else if (item.sentiment === 'bearish') {
                    bearishScore += score;
                }
            });

            // –ò—Ç–æ–≥–æ–≤—ã–π —Å—á—ë—Ç: –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –±—ã—á–∏–π –¥–ª—è Si, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –º–µ–¥–≤–µ–∂–∏–π
            const netScore = bullishScore - bearishScore;
            analysisState.news.score = netScore;
            analysisState.news.direction = netScore > 10 ? 'bullish' : netScore < -10 ? 'bearish' : 'neutral';
            analysisState.news.items = news;

            updateInfluenceUI();
        }

        function filterNews(type, event) {
            currentNewsFilter = type;

            document.querySelectorAll('#newsContainer .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }

            let filtered = allNews;

            if (type === 'bullish') {
                filtered = allNews.filter(n => n.sentiment === 'bullish');
            } else if (type === 'bearish') {
                filtered = allNews.filter(n => n.sentiment === 'bearish');
            }

            renderNews(filtered);
        }

        function refreshNews() {
            fetchNews();
        }

        // ============================================
        // –û–ë–ù–û–í–õ–ï–ù–ò–ï UI –í–õ–ò–Ø–ù–ò–Ø
        // ============================================
        function updateInfluenceUI() {
            // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
            const techScore = analysisState.technical.score;
            const techBar = document.getElementById('techBar');
            const techScoreEl = document.getElementById('techScore');

            techBar.style.width = Math.abs(techScore) + '%';
            techBar.className = 'influence-fill ' + (techScore > 10 ? 'bullish' : techScore < -10 ? 'bearish' : 'neutral');
            techScoreEl.textContent = techScore > 0 ? '+' + Math.round(techScore) : Math.round(techScore);
            techScoreEl.className = 'influence-value ' + (techScore > 10 ? 'positive' : techScore < -10 ? 'negative' : '');

            // –ù–æ–≤–æ—Å—Ç–∏
            const newsScore = analysisState.news.score;
            const newsBar = document.getElementById('newsBar');
            const newsScoreEl = document.getElementById('newsScore');

            newsBar.style.width = Math.min(100, Math.abs(newsScore)) + '%';
            newsBar.className = 'influence-fill ' + (newsScore > 10 ? 'bullish' : newsScore < -10 ? 'bearish' : 'neutral');
            newsScoreEl.textContent = newsScore > 0 ? '+' + Math.round(newsScore) : Math.round(newsScore);
            newsScoreEl.className = 'influence-value ' + (newsScore > 10 ? 'positive' : newsScore < -10 ? 'negative' : '');

            // –ö–∞–ª–µ–Ω–¥–∞—Ä—å
            const calendarScore = analysisState.calendar.score;
            const calendarBar = document.getElementById('calendarBar');
            const calendarScoreEl = document.getElementById('calendarScore');

            calendarBar.style.width = Math.min(100, calendarScore) + '%';
            calendarBar.className = 'influence-fill neutral';
            calendarScoreEl.textContent = Math.round(calendarScore);

            // –ò—Ç–æ–≥–æ (–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞)
            const totalScore = techScore * 0.5 + newsScore * 0.35 + (calendarScore > 30 ? 15 : 0);
            const totalBar = document.getElementById('totalBar');
            const totalScoreEl = document.getElementById('totalScore');

            totalBar.style.width = Math.min(100, Math.abs(totalScore)) + '%';
            totalBar.className = 'influence-fill ' + (totalScore > 15 ? 'bullish' : totalScore < -15 ? 'bearish' : 'neutral');
            totalScoreEl.textContent = totalScore > 0 ? '+' + Math.round(totalScore) : Math.round(totalScore);
            totalScoreEl.className = 'influence-value ' + (totalScore > 15 ? 'positive' : totalScore < -15 ? 'negative' : '');

            analysisState.total.score = totalScore;
            analysisState.total.direction = totalScore > 15 ? 'bullish' : totalScore < -15 ? 'bearish' : 'neutral';
        }

        // ============================================
        // –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –ê–ù–ê–õ–ò–ó –° –ò–ò
        // ============================================
        async function runComplexAnalysis() {
            const apiKey = document.getElementById('api_key_input').value.trim();
            if (!apiKey) {
                alert("–í–≤–µ–¥–∏—Ç–µ API-–∫–ª—é—á OpenRouter");
                return;
            }
            if (!historyData?.length) {
                alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞");
                return;
            }

            document.getElementById('signal_text').innerText = "–ê–ù–ê–õ–ò–ó...";
            document.getElementById('signal_confidence').innerText = "";

            // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
            const techAnalysis = calculateTechnicalAnalysis(historyData);
            analysisState.technical = techAnalysis;
            updateInfluenceUI();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('statsGrid').style.display = 'grid';
            document.getElementById('statRsi').innerText = techAnalysis.rsi?.toFixed(1) || '-';
            document.getElementById('statMacd').innerText = techAnalysis.macd?.histogram?.slice(-1)[0]?.toFixed(2) || '-';
            document.getElementById('statEma').innerText = `${techAnalysis.ema20?.toFixed(0) || '-'}/${techAnalysis.ema50?.toFixed(0) || '-'}`;
            document.getElementById('statTrend').innerText = techAnalysis.direction === 'bullish' ? '‚Üë –í–æ—Å—Ö–æ–¥—è—â–∏–π' : 
                techAnalysis.direction === 'bearish' ? '‚Üì –ù–∏—Å—Ö–æ–¥—è—â–∏–π' : '‚Üí –ë–æ–∫–æ–≤–∏–∫';

            // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ò–ò
            const currentPrice = historyData[historyData.length - 1].close;
            const recentData = historyData.slice(-20);

            const context = {
                price: currentPrice,
                timeframe: currentTf,
                technical: {
                    rsi: techAnalysis.rsi,
                    macd: techAnalysis.macd?.histogram?.slice(-3),
                    ema20: techAnalysis.ema20,
                    ema50: techAnalysis.ema50,
                    trend: techAnalysis.direction,
                    score: techAnalysis.score
                },
                news: allNews.slice(0, 5).map(n => ({
                    title: n.title,
                    sentiment: n.sentiment,
                    impact: n.impact
                })),
                calendar: allCalendarEvents.slice(0, 5).map(e => ({
                    name: e.name,
                    impact: e.impact,
                    currency: e.currency,
                    hoursUntil: ((e.time - new Date()) / (1000 * 60 * 60)).toFixed(1)
                })),
                factors: techAnalysis.factors
            };

            const requestBody = {
                model: "deepseek/deepseek-chat",
                messages: [{
                    role: "user",
                    content: `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä —Ñ—å—é—á–µ—Ä—Å–∞–º–∏ –Ω–∞ —Ä—É–±–ª—å/–¥–æ–ª–ª–∞—Ä (Si).
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –∏ –¥–∞–π —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª.

–ö–û–ù–¢–ï–ö–°–¢:
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ${TICKER}
- –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: ${currentPrice}
- –¢–∞–π–º—Ñ—Ä–µ–π–º: ${currentTf} –º–∏–Ω

–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó (–æ—Ü–µ–Ω–∫–∞: ${context.technical.score}):
- RSI(14): ${context.technical.rsi?.toFixed(1)}
- MACD histogram: ${JSON.stringify(context.technical.macd)}
- EMA20: ${context.technical.ema20?.toFixed(2)}, EMA50: ${context.technical.ema50?.toFixed(2)}
- –¢—Ä–µ–Ω–¥: ${context.technical.trend}
- –§–∞–∫—Ç–æ—Ä—ã: ${JSON.stringify(context.factors)}

–ù–û–í–û–°–¢–ù–û–ô –§–û–ù:
 ${context.news.map(n => `- ${n.title} (${n.sentiment}, ${n.impact})`).join('\n')}

–≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–ò–ô –ö–ê–õ–ï–ù–î–ê–†–¨:
 ${context.calendar.map(e => `- ${e.name} —á–µ—Ä–µ–∑ ${e.hoursUntil}—á (${e.impact}, ${e.currency})`).join('\n')}

–ó–ê–î–ê–ß–ê:
1. –£—á—Ç–∏ –í–°–ï —Ñ–∞–∫—Ç–æ—Ä—ã: —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ, –Ω–æ–≤–æ—Å—Ç–∏, –∫–∞–ª–µ–Ω–¥–∞—Ä—å
2. –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª
3. –£–∫–∞–∂–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (0-100)
4. –î–∞–π –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
  "signal": "–ü–û–ö–£–ü–ö–ê|–ü–†–û–î–ê–ñ–ê|–î–ï–†–ñ–ê–¢–¨",
  "confidence": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100,
  "reason": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è (–¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤)",
  "factors": ["—Ñ–∞–∫—Ç–æ—Ä1", "—Ñ–∞–∫—Ç–æ—Ä2", "—Ñ–∞–∫—Ç–æ—Ä3"]
}`
                }]
            };

            let apiUrl = "https://openrouter.ai/api/v1/chat/completions";
            const fetchOptions = {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${apiKey}`,
                    "Content-Type": "application/json",
                    "HTTP-Referer": window.location.href,
                    "X-Title": "Si Complex Analyzer"
                },
                body: JSON.stringify(requestBody)
            };

            if (useProxy) {
                apiUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`;
            }

            try {
                const response = await fetch(apiUrl, fetchOptions);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const aiRes = await response.json();
                if (aiRes.error) throw new Error(aiRes.error.message);

                const result = parseAIResponse(aiRes.choices[0].message.content);

                // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å–∏–≥–Ω–∞–ª–∞
                const ui = document.getElementById('signal_ui');
                const stext = document.getElementById('signal_text');
                const confEl = document.getElementById('signal_confidence');
                const descEl = document.getElementById('ai_desc');

                ui.className = "signal-display";
                if (result.signal === "–ü–û–ö–£–ü–ö–ê") {
                    ui.classList.add("buy");
                    stext.innerText = "–ü–û–ö–£–ü–ö–ê";
                } else if (result.signal === "–ü–†–û–î–ê–ñ–ê") {
                    ui.classList.add("sell");
                    stext.innerText = "–ü–†–û–î–ê–ñ–ê";
                } else {
                    ui.classList.add("hold");
                    stext.innerText = "–î–ï–†–ñ–ê–¢–¨";
                }

                confEl.innerText = `–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${result.confidence}%`;
                descEl.innerText = result.reason;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∞–∫—Ç–æ—Ä—ã
                const summaryEl = document.getElementById('analysisSummary');
                const factorsEl = document.getElementById('analysisFactors');
                summaryEl.style.display = 'block';

                factorsEl.innerHTML = result.factors?.map(f => `
                    <div class="factor-row">
                        <span class="factor-icon">‚Ä¢</span>
                        <span class="factor-text">${f}</span>
                    </div>
                `).join('') || '<div class="factor-row"><span class="factor-text">–§–∞–∫—Ç–æ—Ä—ã –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã</span></div>';

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª
                const signalChanged = processNewSignal(result.signal, currentPrice, result.reason, result.confidence);

            } catch (e) {
                console.error("AI Analysis Error:", e);
                document.getElementById('signal_text').innerText = "–û–®–ò–ë–ö–ê";
                document.getElementById('ai_desc').innerText = e.message;
            }
        }

        function parseAIResponse(answer) {
            const defaultResult = {
                signal: "–î–ï–†–ñ–ê–¢–¨",
                confidence: 50,
                reason: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö",
                factors: []
            };

            try {
                const jsonMatch = answer.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    return { ...defaultResult, ...parsed };
                }
            } catch (e) {
                // Fallback parsing
                const upper = answer.toUpperCase();
                if (upper.includes("–ü–û–ö–£–ü–ö–ê") || upper.includes("BUY")) {
                    return { ...defaultResult, signal: "–ü–û–ö–£–ü–ö–ê", reason: answer.substring(0, 100) };
                }
                if (upper.includes("–ü–†–û–î–ê–ñ–ê") || upper.includes("SELL")) {
                    return { ...defaultResult, signal: "–ü–†–û–î–ê–ñ–ê", reason: answer.substring(0, 100) };
                }
            }

            return defaultResult;
        }

        function processNewSignal(newSignal, price, reason, confidence) {
            if (lastSignal !== newSignal) {
                console.log(`–°–∏–≥–Ω–∞–ª –∏–∑–º–µ–Ω–∏–ª—Å—è: ${lastSignal} ‚Üí ${newSignal}`);
                showNotification(newSignal, price, reason, confidence);
                lastSignal = newSignal;
                return true;
            }
            return false;
        }

        // ============================================
        // MOEX DATA FETCHING
        // ============================================
        function getFromDate(daysBack) {
            const date = new Date();
            date.setDate(date.getDate() - daysBack);
            return date.toISOString().split('T')[0];
        }

        function getTillDate() {
            const date = new Date();
            date.setDate(date.getDate() + 1);
            return date.toISOString().split('T')[0];
        }

        async function fetchMoexData(timeframe = 60, isUpdate = false) {
            const loadingEl = document.getElementById('loading');
            const interval = tfMap[timeframe];

            if (!interval) {
                loadingEl.innerHTML = '‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º';
                return;
            }

            if (!isUpdate) loadingEl.style.display = 'flex';

            let daysBack = 7;
            if (timeframe === 1) daysBack = 1;
            else if (timeframe === 10) daysBack = 2;
            else if (timeframe === 60) daysBack = 14;
            else if (timeframe === 240) daysBack = 30;
            else if (timeframe === 1440) daysBack = 90;
            else if (timeframe === 10080) daysBack = 365;

            const fromDate = getFromDate(daysBack);
            const tillDate = getTillDate();
            const url = `https://iss.moex.com/iss/engines/futures/markets/forts/securities/${TICKER}/candles.json?interval=${interval}&from=${fromDate}&till=${tillDate}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                if (!data.candles?.data?.length) {
                    throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
                }

                const columns = data.candles.columns;
                const idx = {
                    open: columns.indexOf('open'),
                    close: columns.indexOf('close'),
                    high: columns.indexOf('high'),
                    low: columns.indexOf('low'),
                    begin: columns.indexOf('begin')
                };

                const newData = data.candles.data.map(c => ({
                    time: Math.floor(new Date(c[idx.begin]).getTime() / 1000),
                    open: parseFloat(c[idx.open]),
                    high: parseFloat(c[idx.high]),
                    low: parseFloat(c[idx.low]),
                    close: parseFloat(c[idx.close])
                })).filter(c => !isNaN(c.close));

                newData.sort((a, b) => a.time - b.time);

                if (newData.length > 0) {
                    const lastTime = newData[newData.length - 1].time;

                    if (!isUpdate || lastTime > lastCandleTime || newData.length !== historyData.length) {
                        historyData = newData;
                        lastCandleTime = lastTime;

                        if (!isUpdate) {
                            renderChart(historyData);
                        } else {
                            updateChartData(historyData);
                        }

                        updatePriceTicker(historyData);
                        updateLastUpdateTime();

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                        const techAnalysis = calculateTechnicalAnalysis(historyData);
                        analysisState.technical = techAnalysis;
                        updateInfluenceUI();
                    }
                }

                if (!isUpdate) loadingEl.style.display = 'none';

            } catch (err) {
                console.error("MOEX Error:", err);
                if (!isUpdate) loadingEl.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
            }
        }

        function renderChart(data) {
            if (typeof LightweightCharts === 'undefined') return;

            const chartContainer = document.getElementById('chart');
            const loadingEl = document.getElementById('loading');
            chartContainer.innerHTML = '';
            chartContainer.appendChild(loadingEl);

            currentChart = LightweightCharts.createChart(chartContainer, {
                layout: { background: { color: '#161b22' }, textColor: '#d1d4dc', fontSize: 12 },
                grid: { vertLines: { color: '#30363d' }, horzLines: { color: '#30363d' } },
                timeScale: { borderColor: '#30363d', timeVisible: true, secondsVisible: false, rightOffset: 5, barSpacing: 6 },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                width: chartContainer.clientWidth,
                height: 400,
            });

            candleSeries = currentChart.addCandlestickSeries({
                upColor: '#238636',
                downColor: '#f85149',
                borderVisible: false,
                wickVisible: true,
                priceFormat: { type: 'price', precision: 2, minMove: 0.01 },
            });

            candleSeries.setData(data);
            currentChart.timeScale().fitContent();
        }

        function updateChartData(data) {
            if (!candleSeries) { renderChart(data); return; }
            candleSeries.setData(data);
            currentChart.timeScale().fitContent();
        }

        function updatePriceTicker(data) {
            if (!data?.length) return;
            const last = data[data.length - 1];
            const prev = data[data.length - 2] || last;
            const change = last.close - prev.close;
            const changePercent = (change / prev.close) * 100;

            document.getElementById('currentPrice').innerText = last.close.toFixed(2);
            const sign = change >= 0 ? '+' : '';
            const cls = change >= 0 ? 'positive' : 'negative';

            document.getElementById('priceChange').innerText = `${sign}${change.toFixed(2)}`;
            document.getElementById('priceChange').className = `ticker-change ${cls}`;
            document.getElementById('changePercent').innerText = `${sign}${changePercent.toFixed(2)}%`;
            document.getElementById('changePercent').className = `ticker-value ${cls}`;
        }

        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').innerText =
                `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleTimeString('ru-RU')} (–ú–°–ö)`;
        }

        function initTimeframeButtons() {
            document.getElementById('tfSelector').addEventListener('click', function(e) {
                const btn = e.target.closest('.tf-btn');
                if (!btn) return;

                const newTf = parseInt(btn.dataset.tf);
                if (newTf === currentTf) return;

                document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                currentTf = newTf;
                lastCandleTime = 0;
                fetchMoexData(newTf, false);
            });
        }

        // ============================================
        // –ù–ê–°–¢–†–û–ô–ö–ò –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï
        // ============================================
        function toggleSetting(setting) {
            settings[setting] = !settings[setting];
            document.getElementById(setting + 'Toggle').classList.toggle('active', settings[setting]);
            localStorage.setItem('si_settings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('si_settings');
            if (saved) {
                Object.assign(settings, JSON.parse(saved));
                Object.keys(settings).forEach(key => {
                    document.getElementById(key + 'Toggle')?.classList.toggle('active', settings[key]);
                });
            }
        }

        function testSignal() {
            const signals = ['–ü–û–ö–£–ü–ö–ê', '–ü–†–û–î–ê–ñ–ê', '–î–ï–†–ñ–ê–¢–¨'];
            const randomSignal = signals[Math.floor(Math.random() * signals.length)];
            const testPrice = 76683 + (Math.random() - 0.5) * 1000;

            showNotification(randomSignal, testPrice, '–¢–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', 75);
        }

        function startAutoUpdate() {
            stopAutoUpdate();
            countdownSeconds = 30;
            updateTimerDisplay();

            autoUpdateInterval = setInterval(() => {
                if (document.getElementById('autoUpdateCheck').checked) {
                    fetchMoexData(currentTf, true);
                }
            }, 30000);

            countdownInterval = setInterval(() => {
                if (document.getElementById('autoUpdateCheck').checked) {
                    countdownSeconds--;
                    if (countdownSeconds <= 0) countdownSeconds = 30;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function stopAutoUpdate() {
            if (autoUpdateInterval) clearInterval(autoUpdateInterval);
            if (countdownInterval) clearInterval(countdownInterval);
        }

        function updateTimerDisplay() {
            const m = Math.floor(countdownSeconds / 60);
            const s = countdownSeconds % 60;
            document.getElementById('timerDisplay').innerText =
                `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function saveConfig() {
            const key = document.getElementById('api_key_input').value.trim();
            if (key) localStorage.setItem('si_key', key);
            else localStorage.removeItem('si_key');
            alert(key ? "–ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω" : "–ö–ª—é—á —É–¥–∞–ª—ë–Ω");
        }

        function toggleProxy() {
            useProxy = !useProxy;
            const btn = document.getElementById('proxyBtn');
            btn.innerText = useProxy ? "üîÅ CORS-–ø—Ä–æ–∫—Å–∏: –í–ö–õ" : "üîÅ CORS-–ø—Ä–æ–∫—Å–∏: –í–´–ö–õ";
            btn.classList.toggle('active', useProxy);
        }

        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ============================================
        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();

            const savedKey = localStorage.getItem('si_key');
            if (savedKey) document.getElementById('api_key_input').value = savedKey;

            initTimeframeButtons();
            fetchMoexData(60, false);
            fetchEconomicCalendar();
            fetchNews();

            if (document.getElementById('autoUpdateCheck').checked) {
                startAutoUpdate();
            }

            document.getElementById('autoUpdateCheck').addEventListener('change', (e) => {
                e.target.checked ? startAutoUpdate() : stopAutoUpdate();
            });

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
        });
    </script>

<script>
/**
 * Iframe ÂÖÉÁ¥†È´ò‰∫ÆÊ≥®ÂÖ•ËÑöÊú¨
 * ÈúÄË¶ÅÂú®ÁõÆÊ†áÁΩëÁ´ô‰∏≠ÂºïÂÖ•Ê≠§ËÑöÊú¨Êù•ÊîØÊåÅË∑®Âüü iframe È´ò‰∫ÆÂäüËÉΩ
 *
 * ‰ΩøÁî®ÊñπÊ≥ïÔºö
 * 1. Â∞ÜÊ≠§ËÑöÊú¨Ê∑ªÂä†Âà∞ÁõÆÊ†áÁΩëÁ´ôÁöÑ HTML ‰∏≠
 * 2. ÊàñÈÄöËøáÊµèËßàÂô®Êâ©Â±ï„ÄÅÁî®Êà∑ËÑöÊú¨Á≠âÊñπÂºèÊ≥®ÂÖ•
 */

(function () {
  "use strict";

  // Ê£ÄÊü•ÊòØÂê¶Âú® iframe ‰∏≠
  if (window.self === window.top) {
    return; // ‰∏çÂú® iframe ‰∏≠Ôºå‰∏çÊâßË°å
  }

  // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂàùÂßãÂåñËøá
  if (window.__iframeHighlightInitialized) {
    return;
  }
  window.__iframeHighlightInitialized = true;
  console.log("Iframe È´ò‰∫ÆËÑöÊú¨Â∑≤Âä†ËΩΩ");

  // ÂàõÂª∫È´ò‰∫ÆË¶ÜÁõñÂ±Ç
  var overlay = document.createElement("div");
  overlay.id = "iframe-highlight-overlay";
  overlay.style.cssText = "\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100vw;\n    height: 100vh;\n    pointer-events: none;\n    z-index: 999999;\n    overflow: hidden;\n  ";

  // ÂàõÂª∫ÊÇ¨ÂÅúÈ´ò‰∫ÆÊ°ÜÔºàËôöÁ∫øËæπÊ°ÜÔºâ
  var highlightBox = document.createElement("div");
  highlightBox.id = "iframe-highlight-box";
  highlightBox.style.cssText = "\n    position: absolute;\n    border: 2px dashed #007AFF;\n    background: rgba(0, 122, 255, 0.08);\n    pointer-events: none;\n    display: none;\n    transition: all 0.1s ease;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8);\n    border-radius: 2px;\n  ";

  // ÂàõÂª∫ÈÄâ‰∏≠ËäÇÁÇπÁöÑÂ∏∏È©ªÈ´ò‰∫ÆÊ°ÜÔºàÂÆûÁ∫øËæπÊ°ÜÔºâ
  var selectedBox = document.createElement("div");
  selectedBox.id = "iframe-selected-box";
  selectedBox.style.cssText = "\n    position: absolute;\n    border: 2px solid #007AFF;\n    pointer-events: none;\n    display: none;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.9), 0 0 8px rgba(255, 107, 53, 0.4);\n    border-radius: 2px;\n    z-index: 1000000;\n  ";

  // ÂàõÂª∫ÊÇ¨ÂÅúÊ†áÁ≠æÊòæÁ§∫
  var tagLabel = document.createElement("div");
  tagLabel.id = "iframe-tag-label";
  tagLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 2px 6px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 2px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000001;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n    font-weight: 500;\n  ";

  // ÂàõÂª∫ÈÄâ‰∏≠ËäÇÁÇπÊ†áÁ≠æ
  var selectedLabel = document.createElement("div");
  selectedLabel.id = "iframe-selected-label";
  selectedLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 3px 8px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 3px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000002;\n    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);\n    font-weight: 600;\n  ";
  overlay.appendChild(highlightBox);
  overlay.appendChild(selectedBox);
  overlay.appendChild(tagLabel);
  overlay.appendChild(selectedLabel);
  document.body.appendChild(overlay);

  // Â≠òÂÇ®ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂÖÉÁ¥†
  var selectedElement = null;
  var highlightEnabled = false;

  // Êõ¥Êñ∞ÈÄâ‰∏≠ÂÖÉÁ¥†ÁöÑÈ´ò‰∫ÆÊòæÁ§∫
  function updateSelectedHighlight(element) {
    console.log("updateSelectedHighlight called with:", element);
    if (!element) {
      selectedBox.style.display = "none";
      selectedLabel.style.display = "none";
      selectedElement = null;
      console.log("Cleared selected highlight");
      return;
    }
    selectedElement = element;
    var rect = element.getBoundingClientRect();
    console.log("Selected element rect:", rect);

    // Êõ¥Êñ∞ÈÄâ‰∏≠È´ò‰∫ÆÊ°Ü‰ΩçÁΩÆ
    selectedBox.style.display = "block";
    selectedBox.style.left = "".concat(rect.left - 2, "px");
    selectedBox.style.top = "".concat(rect.top - 2, "px");
    selectedBox.style.width = "".concat(rect.width + 4, "px");
    selectedBox.style.height = "".concat(rect.height + 4, "px");

    // Êõ¥Êñ∞ÈÄâ‰∏≠Ê†áÁ≠æ‰ΩçÁΩÆÂíåÂÜÖÂÆπ
    selectedLabel.style.display = "block";
    selectedLabel.textContent = "\u2713 <".concat(element.tagName.toLowerCase(), ">");

    // ËÆ°ÁÆóÊ†áÁ≠æ‰ΩçÁΩÆÔºåÁ°Æ‰øù‰∏çË∂ÖÂá∫ËßÜÁ™ó
    var labelTop = rect.top - 28;
    var labelLeft = rect.left;

    // Â¶ÇÊûúÊ†áÁ≠æ‰ºöË∂ÖÂá∫È°∂ÈÉ®ÔºåÊòæÁ§∫Âú®ÂÖÉÁ¥†‰∏ãÊñπ
    if (labelTop < 5) {
      labelTop = rect.bottom + 5;
    }

    // Â¶ÇÊûúÊ†áÁ≠æ‰ºöË∂ÖÂá∫Âè≥‰æßÔºåÂêëÂ∑¶Ë∞ÉÊï¥
    var labelWidth = selectedLabel.offsetWidth || 100; // È¢Ñ‰º∞ÂÆΩÂ∫¶
    if (labelLeft + labelWidth > window.innerWidth - 10) {
      labelLeft = window.innerWidth - labelWidth - 10;
    }
    selectedLabel.style.left = "".concat(Math.max(5, labelLeft), "px");
    selectedLabel.style.top = "".concat(labelTop, "px");
    console.log("Selected highlight positioned at:", {
      left: selectedBox.style.left,
      top: selectedBox.style.top,
      width: selectedBox.style.width,
      height: selectedBox.style.height
    });
  }
  function getElementSelector(element) {
    if (!(element instanceof Element)) throw new Error('Argument must be a DOM element');
    var segments = [];
    var current = element;
    while (current !== document.documentElement) {
      var selector = '';
      // ‰ºòÂÖàÊ£ÄÊü•ÂîØ‰∏ÄID
      if (current.id && document.querySelectorAll("#".concat(current.id)).length === 1) {
        segments.unshift("#".concat(current.id));
        break; // IDÂîØ‰∏ÄÔºåÊó†ÈúÄÁªßÁª≠Âêë‰∏ä
      }

      // ÁîüÊàêÁ±ªÂêçÈÄâÊã©Âô®ÔºàÂèñÁ¨¨‰∏Ä‰∏™ÊúâÊïàÁ±ªÂêçÔºâ
      var classes = Array.from(current.classList).filter(function (c) {
        return !c.startsWith('js-');
      });
      var className = classes.length > 0 ? ".".concat(classes[0]) : '';

      // ÁîüÊàê‰ΩçÁΩÆÁ¥¢ÂºïÔºànth-childÔºâ
      var tag = current.tagName.toLowerCase();
      if (!className) {
        var siblings = Array.from(current.parentNode.children);
        var index = siblings.findIndex(function (el) {
          return el === current;
        }) + 1;
        selector = "".concat(tag, ":nth-child(").concat(index, ")");
      } else {
        selector = className;
      }
      segments.unshift(selector);
      current = current.parentElement;
    }

    // Â§ÑÁêÜÊ†πÂÖÉÁ¥†
    if (current === document.documentElement) {
      segments.unshift('html');
    }
    return segments.join(' > ');
  }

  // Ëé∑ÂèñÂÖÉÁ¥†ÊñáÊú¨ÂÜÖÂÆπ
  function getElementText(element) {
    var _element$textContent;
    if (element.tagName === "INPUT") {
      return element.value || element.placeholder || "";
    }
    if (element.tagName === "TEXTAREA") {
      return element.value || element.placeholder || "";
    }
    var text = ((_element$textContent = element.textContent) === null || _element$textContent === void 0 ? void 0 : _element$textContent.trim()) || "";
    return text.length > 50 ? text.substring(0, 50) + "..." : text;
  }

  // Ëé∑ÂèñÂÖÉÁ¥†Â±ûÊÄß‰ø°ÊÅØ
  function getElementAttributes(element) {
    var attrs = {};
    for (var i = 0; i < element.attributes.length; i++) {
      var attr = element.attributes[i];
      attrs[attr.name] = attr.value;
    }
    return attrs;
  }

  // Èº†Ê†áÊÇ¨ÂÅú‰∫ã‰ª∂Â§ÑÁêÜ
  function handleMouseOver(e) {
    if (!highlightEnabled) return;
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // ÈÅøÂÖçÈ´ò‰∫Æ html Âíå body ÂÖÉÁ¥†
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // Â¶ÇÊûúÊòØÂ∑≤ÈÄâ‰∏≠ÁöÑÂÖÉÁ¥†Ôºå‰∏çÊòæÁ§∫ÊÇ¨ÂÅúÈ´ò‰∫Æ
    if (target === selectedElement) {
      highlightBox.style.display = "none";
      tagLabel.style.display = "none";
      return;
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);

    // Êõ¥Êñ∞ÊÇ¨ÂÅúÈ´ò‰∫ÆÊ°Ü‰ΩçÁΩÆ
    highlightBox.style.display = "block";
    highlightBox.style.left = "".concat(rect.left - 2, "px");
    highlightBox.style.top = "".concat(rect.top - 2, "px");
    highlightBox.style.width = "".concat(rect.width + 4, "px");
    highlightBox.style.height = "".concat(rect.height + 4, "px");

    // Êõ¥Êñ∞Ê†áÁ≠æ‰ΩçÁΩÆÂíåÂÜÖÂÆπ
    tagLabel.style.display = "block";
    tagLabel.textContent = "<".concat(target.tagName.toLowerCase(), ">");

    // ËÆ°ÁÆóÊ†áÁ≠æ‰ΩçÁΩÆÔºåÁ°Æ‰øù‰∏çË∂ÖÂá∫ËßÜÁ™ó
    var labelTop = rect.top - 22;
    var labelLeft = rect.left;

    // Â¶ÇÊûúÊ†áÁ≠æ‰ºöË∂ÖÂá∫È°∂ÈÉ®ÔºåÊòæÁ§∫Âú®ÂÖÉÁ¥†‰∏ãÊñπ
    if (labelTop < 0) {
      labelTop = rect.bottom + 5;
    }

    // Â¶ÇÊûúÊ†áÁ≠æ‰ºöË∂ÖÂá∫Âè≥‰æßÔºåÂêëÂ∑¶Ë∞ÉÊï¥
    if (labelLeft + tagLabel.offsetWidth > window.innerWidth) {
      labelLeft = window.innerWidth - tagLabel.offsetWidth - 5;
    }
    tagLabel.style.left = "".concat(Math.max(0, labelLeft), "px");
    tagLabel.style.top = "".concat(labelTop, "px");

    // ÂèëÈÄÅÊ∂àÊÅØÂà∞Áà∂Á™óÂè£
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("Êó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØÂà∞Áà∂Á™óÂè£:", error);
    }
  }

  // Èº†Ê†áÁ¶ªÂºÄ‰∫ã‰ª∂Â§ÑÁêÜ
  function handleMouseOut(e) {
    if (!highlightEnabled) return;
    var relatedTarget = e.relatedTarget;

    // Â¶ÇÊûúÈº†Ê†áÁßªÂä®Âà∞È´ò‰∫ÆÁõ∏ÂÖ≥ÂÖÉÁ¥†‰∏äÔºå‰∏çÈöêËóèÈ´ò‰∫Æ
    if (relatedTarget && (relatedTarget === highlightBox || relatedTarget === tagLabel || relatedTarget === overlay || relatedTarget === selectedBox || relatedTarget === selectedLabel)) {
      return;
    }
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: null,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("Êó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØÂà∞Áà∂Á™óÂè£:", error);
    }
  }

  // ÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ
  function handleClick(e) {
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // ÈÅøÂÖçÂ§ÑÁêÜ html Âíå body ÂÖÉÁ¥†
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰∫§‰∫íÂÖÉÁ¥†ÔºåËøô‰∫õÂÖÉÁ¥†ÈúÄË¶Å‰øùÁïôÈªòËÆ§Ë°å‰∏∫
    var isInteractiveElement = ['input', 'textarea', 'select', 'button', 'a'].includes(target.tagName.toLowerCase());

    // Â¶ÇÊûúÈ´ò‰∫ÆÂäüËÉΩÂêØÁî®ÔºåÂØπ‰∫éÈùû‰∫§‰∫íÂÖÉÁ¥†ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫Âíå‰∫ã‰ª∂‰º†Êí≠
    if (highlightEnabled) {
      e.preventDefault();
      e.stopPropagation();
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);
    console.log("Element clicked:", {
      tagName: target.tagName,
      selector: selector,
      rect: rect
    });

    // Á´ãÂç≥Êõ¥Êñ∞ÈÄâ‰∏≠È´ò‰∫Æ
    updateSelectedHighlight(target);

    // ÈöêËóèÊÇ¨ÂÅúÈ´ò‰∫ÆÔºåÂõ†‰∏∫Áé∞Âú®ÊòØÈÄâ‰∏≠Áä∂ÊÄÅ
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-click",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("Êó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØÂà∞Áà∂Á™óÂè£:", error);
    }
  }

  // ÁõëÂê¨Êù•Ëá™Áà∂Á™óÂè£ÁöÑÊ∂àÊÅØ
  function handleParentMessage(event) {
    console.log("Received message from parent:", event.data);
    if (event.data.type === "iframe-highlight-toggle") {
      var enabled = event.data.enabled;
      console.log("Highlight toggle:", enabled);
      if (enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "enable-iframe-highlight") {
      console.log("Enable iframe highlight");
      enableHighlight();
    } else if (event.data.type === "disable-iframe-highlight") {
      console.log("Disable iframe highlight");
      disableHighlight();
    } else if (event.data.type === "toggle-iframe-highlight") {
      var _enabled = event.data.enabled !== undefined ? event.data.enabled : !highlightEnabled;
      console.log("Toggle iframe highlight to:", _enabled);
      if (_enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "update-selected-element") {
      var selector = event.data.selector;
      console.log("Update selected element with selector:", selector);
      if (selector) {
        try {
          var element = document.querySelector(selector);
          console.log("Found element by selector:", element);
          updateSelectedHighlight(element);
        } catch (error) {
          console.warn("Failed to select element:", error);
          updateSelectedHighlight(null);
        }
      } else {
        updateSelectedHighlight(null);
      }
    } else if (event.data.type === "clear-selected-element") {
      console.log("Clear selected element");
      updateSelectedHighlight(null);
    }
  }

  // ÂêØÁî®È´ò‰∫ÆÂäüËÉΩ
  function enableHighlight() {
    console.log("Enabling highlight");
    document.addEventListener("mouseover", handleMouseOver, true);
    document.addEventListener("mouseout", handleMouseOut, true);
    document.addEventListener("click", handleClick, true);
    highlightEnabled = true;
    overlay.style.display = "block";
  }

  // Á¶ÅÁî®È´ò‰∫ÆÂäüËÉΩ
  function disableHighlight() {
    console.log("Disabling highlight");
    highlightEnabled = false;
    // ‰øùÊåÅ‰∫ã‰ª∂ÁõëÂê¨Âô®Ôºå‰ΩÜÈÄöËøá highlightEnabled ÂèòÈáèÊéßÂà∂Ë°å‰∏∫
    // ËøôÊ†∑ÂèØ‰ª•‰øùÁïôÈÄâ‰∏≠Áä∂ÊÄÅÁöÑÊòæÁ§∫
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    // ‰∏çÈöêËóè selectedBox Âíå selectedLabelÔºå‰øùÁïôÈÄâ‰∏≠Áä∂ÊÄÅ
  }

  // ÂÆåÂÖ®Á¶ÅÁî®È´ò‰∫ÆÂäüËÉΩÔºàÁßªÈô§ÊâÄÊúâÁõëÂê¨Âô®Ôºâ
  function fullyDisableHighlight() {
    console.log("Fully disabling highlight");
    highlightEnabled = false;
    document.removeEventListener("mouseover", handleMouseOver, true);
    document.removeEventListener("mouseout", handleMouseOut, true);
    document.removeEventListener("click", handleClick, true);
    overlay.style.display = "none";
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    selectedBox.style.display = "none";
    selectedLabel.style.display = "none";
  }

  // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
  enableHighlight();
  window.addEventListener("message", handleParentMessage);

  // Êö¥Èú≤ÂÖ®Â±ÄÂáΩÊï∞‰æõÂ§ñÈÉ®Ë∞ÉÁî®
  window.__iframeHighlightControl = {
    enable: enableHighlight,
    disable: disableHighlight,
    fullyDisable: fullyDisableHighlight,
    isEnabled: function isEnabled() {
      return highlightEnabled;
    },
    getSelectedElement: function getSelectedElement() {
      return selectedElement;
    },
    updateSelected: updateSelectedHighlight,
    // ÈÄöËøáÊ∂àÊÅØÂèëÈÄÅÂºÄÂÖ≥ÊéßÂà∂
    sendToggleMessage: function sendToggleMessage(enabled) {
      window.parent.postMessage({
        type: 'iframe-highlight-status',
        enabled: enabled || highlightEnabled,
        source: 'iframe-highlight-injector'
      }, '*');
    }
  };

  // ÈÄöÁü•Áà∂Á™óÂè£ËÑöÊú¨Â∑≤Âä†ËΩΩ
  try {
    window.parent.postMessage({
      type: "iframe-highlight-ready",
      data: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: Date.now()
      },
      source: "iframe-highlight-injector"
    }, "*");
  } catch (error) {
    console.warn("Êó†Ê≥ïÂèëÈÄÅÂ∞±Áª™Ê∂àÊÅØÂà∞Áà∂Á™óÂè£:", error);
  }

  // Ê∏ÖÁêÜÂáΩÊï∞
  window.__iframeHighlightCleanup = function () {
    fullyDisableHighlight();
    window.removeEventListener("message", handleParentMessage);
    if (overlay.parentElement) {
      overlay.parentElement.removeChild(overlay);
    }
    delete window.__iframeHighlightInitialized;
    delete window.__iframeHighlightCleanup;
  };
})();

</script>
</body>
</html>
